<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sunahh</title>
    
    <!-- PWA / Native App Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Sunahh">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f172a">

    <!-- Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617;
            margin: 0;
            padding: 0;
            overflow: hidden;
            -webkit-user-select: none;
            user-select: none;
            overscroll-behavior: none;
        }

        .font-serif { font-family: 'Playfair Display', serif; }

        /* Smooth Transitions */
        .view-transition { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Pulse Animation */
        @keyframes heartPulse {
            0% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.08); filter: brightness(1.2); }
            100% { transform: scale(1); filter: brightness(1); }
        }
        .animate-heart { animation: heartPulse 0.8s ease-in-out infinite; }

        /* Typing Dots */
        .typing-dot {
            width: 4px; height: 4px; border-radius: 50%; background-color: currentColor;
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        ::-webkit-scrollbar { display: none; }
        
        /* Glassmorphism */
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .glass-high {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, query, orderBy, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        window.fb = { initializeApp, getFirestore, doc, setDoc, onSnapshot, collection, addDoc, query, orderBy, serverTimestamp, updateDoc, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- ICONS ---
        const Icon = ({ name, size = 24, className = "", fill = "none" }) => {
            const icons = {
                Heart: <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" />,
                MessageCircle: <path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z" />,
                Cloud: <path d="M17.5 19c3.037 0 5.5-2.463 5.5-5.5 0-2.812-2.112-5.132-4.832-5.447C17.712 5.093 15.088 3 12 3c-2.73 0-5.074 1.637-6.095 4.02C3.393 7.545 1.5 9.551 1.5 12c0 2.761 2.239 5 5 5h11Z" />,
                Send: <React.Fragment><path d="m22 2-7 20-4-9-9-4Z" /><line x1="22" x2="11" y1="2" y2="13" /></React.Fragment>,
                Sparkles: <React.Fragment><path d="m12 3 1.912 5.813a2 2 0 0 1 1.275 1.275L21 12l-5.813 1.912a2 2 0 0 1-1.275 1.275L12 21l-1.912-5.813a2 2 0 0 1-1.275-1.275L3 12l5.813-1.912a2 2 0 0 1 1.275-1.275L12 3Z" /></React.Fragment>,
                MapPin: <React.Fragment><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z" /><circle cx="12" cy="10" r="3" /></React.Fragment>,
                Clock: <React.Fragment><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></React.Fragment>,
                Smile: <React.Fragment><circle cx="12" cy="12" r="10" /><path d="M8 14s1.5 2 4 2 4-2 4-2" /><line x1="9" x2="9.01" y1="9" y2="9" /><line x1="15" x2="15.01" y1="9" y2="9" /></React.Fragment>,
                Zap: <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />,
                Volume2: <React.Fragment><path d="M11 5 6 9H2v6h4l5 4V5Z" /><path d="M15.54 8.46a5 5 0 0 1 0 7.07" /><path d="M19.07 4.93a10 10 0 0 1 0 14.14" /></React.Fragment>,
                Wand2: <React.Fragment><path d="m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L2.36 18.64a1.21 1.21 0 0 0 0 1.72l1.28 1.28a1.21 1.21 0 0 0 1.72 0L21.64 5.36a1.21 1.21 0 0 0 0-1.72Z" /><path d="m14 7 3 3" /><path d="M5 6v4" /><path d="M19 14v4" /><path d="M10 2v2" /><path d="M7 8H3" /><path d="M21 16h-4" /><path d="M11 3H9" /></React.Fragment>,
                CalendarHeart: <React.Fragment><path d="M21 10V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14c0 1.1.9 2 2 2h7" /><path d="M16 2v4" /><path d="M8 2v4" /><path d="M3 10h18" /><path d="M21.2 13.1a2.4 2.4 0 0 0-3.4 0l-.8.8-.8-.8a2.4 2.4 0 0 0-3.4 3.4l4.2 4.2 4.2-4.2a2.4 2.4 0 0 0 0-3.4Z" /></React.Fragment>,
                Smartphone: <React.Fragment><rect width="14" height="20" x="5" y="2" rx="2" ry="2" /><line x1="12" x2="12" y1="18" y2="18" /></React.Fragment>,
                Loader2: <path d="M21 12a9 9 0 1 1-6.219-8.56" />,
                Settings: <React.Fragment><circle cx="12" cy="12" r="3" /><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1Z" /></React.Fragment>
            };

            return (
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width={size}
                    height={size}
                    viewBox="0 0 24 24"
                    fill={fill}
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    className={className}
                >
                    {icons[name] || null}
                </svg>
            );
        };

        const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
        const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'sunahh-pro';
        const apiKey = ""; // Managed by environment

        const MOODS = [
            { id: 'love', icon: 'üíñ', color: 'from-pink-500 to-rose-600', bg: 'bg-rose-950/20', theme: '#4c0519' },
            { id: 'missing', icon: 'ü•∫', color: 'from-blue-400 to-indigo-600', bg: 'bg-indigo-950/20', theme: '#1e1b4b' },
            { id: 'joy', icon: '‚ú®', color: 'from-amber-300 to-orange-500', bg: 'bg-amber-950/20', theme: '#451a03' },
            { id: 'tired', icon: 'üò¥', color: 'from-purple-400 to-violet-700', bg: 'bg-violet-950/20', theme: '#2e1065' },
            { id: 'angry', icon: 'üí¢', color: 'from-red-500 to-orange-700', bg: 'bg-red-950/20', theme: '#450a0a' },
        ];

        const fetchWithRetry = async (url, options, retries = 5, backoff = 1000) => {
            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
            } catch (error) {
                if (retries > 0) {
                    await new Promise(resolve => setTimeout(resolve, backoff));
                    return fetchWithRetry(url, options, retries - 1, backoff * 2);
                }
                throw error;
            }
        };

        const pcmToWav = (pcmData, sampleRate) => {
            const buffer = new ArrayBuffer(44 + pcmData.length * 2);
            const view = new DataView(buffer);
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i));
            };
            writeString(0, 'RIFF');
            view.setUint32(4, 32 + pcmData.length * 2, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, pcmData.length * 2, true);
            for (let i = 0; i < pcmData.length; i++) view.setInt16(44 + i * 2, pcmData[i], true);
            return new Blob([buffer], { type: 'audio/wav' });
        };

        const App = () => {
            const [loading, setLoading] = useState(true);
            const [user, setUser] = useState(null);
            const [partner, setPartner] = useState(null);
            const [messages, setMessages] = useState([]);
            const [dreams, setDreams] = useState([]);
            const [view, setView] = useState('home'); 
            const [isPressing, setIsPressing] = useState(false);
            const [inputMsg, setInputMsg] = useState('');
            const [isTyping, setIsTyping] = useState(false);
            const [dreamPrompt, setDreamPrompt] = useState('');
            const [isGeneratingDream, setIsGeneratingDream] = useState(false);
            const [isEnhancing, setIsEnhancing] = useState(false);
            const [myMood, setMyMood] = useState('love');
            const [isPlayingAudio, setIsPlayingAudio] = useState(null);
            const [showInstallTip, setShowInstallTip] = useState(false);
            const [currentTime, setCurrentTime] = useState(new Date());

            // Real-time Identity
            const [myId, setMyId] = useState(() => {
                const hash = window.location.hash.replace('#', '').toLowerCase();
                return hash === 'abhishek' ? 'abhishek' : 'sana';
            });

            const partnerId = myId === 'abhishek' ? 'sana' : 'abhishek';

            // Identity Listener
            useEffect(() => {
                const handleHashChange = () => {
                    const hash = window.location.hash.replace('#', '').toLowerCase();
                    setMyId(hash === 'abhishek' ? 'abhishek' : 'sana');
                };
                window.addEventListener('hashchange', handleHashChange);
                return () => window.removeEventListener('hashchange', handleHashChange);
            }, []);

            // Time updater
            useEffect(() => {
                const timer = setInterval(() => setCurrentTime(new Date()), 60000);
                return () => clearInterval(timer);
            }, []);

            // --- INIT FIREBASE ---
            useEffect(() => {
                const checkFirebase = setInterval(() => {
                    if (window.fb) {
                        clearInterval(checkFirebase);
                        startApp();
                    }
                }, 100);

                const startApp = async () => {
                    const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } = window.fb;
                    try {
                        const app = initializeApp(firebaseConfig);
                        const auth = getAuth(app);
                        if (window.__initial_auth_token) {
                            await signInWithCustomToken(auth, window.__initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                        onAuthStateChanged(auth, setUser);
                        
                        const isStandalone = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;
                        if (!isStandalone) setShowInstallTip(true);
                        
                        setTimeout(() => setLoading(false), 2000);
                    } catch (err) {
                        console.error(err);
                        setLoading(false);
                    }
                };
            }, []);

            // --- LISTENERS ---
            useEffect(() => {
                if (!user || !window.fb) return;
                const { doc, onSnapshot, collection, query, orderBy, getFirestore } = window.fb;
                const db = getFirestore();

                const unsubPartner = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'presence', partnerId), (d) => {
                    if (d.exists()) setPartner(d.data());
                });

                const qMsg = query(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), orderBy('timestamp', 'desc'));
                const unsubMsgs = onSnapshot(qMsg, (snap) => {
                    setMessages(snap.docs.map(d => ({ id: d.id, ...d.data() })).reverse());
                });

                const qDreams = query(collection(db, 'artifacts', appId, 'public', 'data', 'dreams'), orderBy('timestamp', 'desc'));
                const unsubDreams = onSnapshot(qDreams, (snap) => setDreams(snap.docs.map(d => ({ id: d.id, ...d.data() }))));

                return () => { unsubPartner(); unsubMsgs(); unsubDreams(); };
            }, [user, partnerId]);

            // --- WRITER & VIBRATION LOGIC ---
            useEffect(() => {
                if (!user || !window.fb) return;
                const { doc, setDoc, serverTimestamp, getFirestore } = window.fb;
                const db = getFirestore();

                const typing = inputMsg.length > 0;
                setIsTyping(typing);

                const interval = setInterval(() => {
                    setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'presence', myId), {
                        uid: user.uid, 
                        lastSeen: serverTimestamp(), 
                        isPressing, 
                        mood: myMood, 
                        id: myId,
                        isTyping: typing 
                    }, { merge: true });
                }, 2000); 

                // Haptic Feedback Logic
                if (isPressing && partner?.isPressing) {
                     // BOTH pressing: Strong interaction
                     if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                } else if (isPressing || partner?.isPressing) {
                     // ONE pressing: Gentle
                     if (navigator.vibrate) navigator.vibrate([20]);
                }

                return () => clearInterval(interval);
            }, [user, isPressing, myMood, myId, inputMsg, partner?.isPressing]);

            // --- ACTIONS ---
            const handleSendMessage = async () => {
                if (!inputMsg.trim()) return;
                const text = inputMsg; 
                setInputMsg('');
                const { addDoc, collection, getFirestore, serverTimestamp } = window.fb;
                await addDoc(collection(getFirestore(), 'artifacts', appId, 'public', 'data', 'messages'), {
                    text, sender: myId, timestamp: serverTimestamp()
                });
            };

            const handleEnhanceWhisper = async () => {
                if (!inputMsg.trim()) return;
                setIsEnhancing(true);
                try {
                    const prompt = `Rewrite this romantic message into something poetic and intimate: "${inputMsg}"`;
                    const result = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const enhanced = result.candidates?.[0]?.content?.parts?.[0]?.text?.replace(/["']/g, "").trim();
                    if (enhanced) setInputMsg(enhanced);
                } finally { setIsEnhancing(false); }
            };

            const handleListenToMessage = async (msgId, text) => {
                if (isPlayingAudio === msgId) return;
                setIsPlayingAudio(msgId);
                try {
                    const payload = {
                        contents: [{ parts: [{ text: `Say warmly and intimately: ${text}` }] }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Aoede" } } }
                        },
                        model: "gemini-2.5-flash-preview-tts"
                    };
                    const result = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const base64Audio = result.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                    if (base64Audio) {
                        const binary = atob(base64Audio);
                        const pcmData = new Int16Array(binary.length / 2);
                        for (let i = 0; i < pcmData.length; i++) pcmData[i] = binary.charCodeAt(i * 2) | (binary.charCodeAt(i * 2 + 1) << 8);
                        const url = URL.createObjectURL(pcmToWav(pcmData, 24000));
                        const audio = new Audio(url);
                        audio.onended = () => setIsPlayingAudio(null);
                        audio.play();
                    }
                } catch(e) { setIsPlayingAudio(null); }
            };

            const handleGenerateDream = async () => {
                if (!dreamPrompt.trim()) return;
                setIsGeneratingDream(true);
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`, {
                        method: 'POST',
                        body: JSON.stringify({
                            instances: { prompt: `Cinematic romantic photography of: ${dreamPrompt}` },
                            parameters: { sampleCount: 1 }
                        })
                    });
                    const data = await response.json();
                    const imageUrl = `data:image/png;base64,${data.predictions[0].bytesBase64Encoded}`;
                    const { addDoc, collection, getFirestore, serverTimestamp } = window.fb;
                    await addDoc(collection(getFirestore(), 'artifacts', appId, 'public', 'data', 'dreams'), {
                        imageUrl, prompt: dreamPrompt, creator: myId, timestamp: serverTimestamp()
                    });
                    setDreamPrompt('');
                } finally { setIsGeneratingDream(false); }
            };

            // --- HELPERS ---
            const getOnlineStatus = () => {
                if (!partner?.lastSeen) return { text: "Offline", isOnline: false };
                
                const lastSeenMillis = partner.lastSeen.toMillis ? partner.lastSeen.toMillis() : 
                                     (partner.lastSeen.seconds ? partner.lastSeen.seconds * 1000 : Date.now());
                
                const diff = Date.now() - lastSeenMillis;
                const mins = Math.floor(diff / 60000);
                
                if (diff < 65000) return { text: "Online Now", isOnline: true };
                if (mins < 60) return { text: `Seen ${mins}m ago`, isOnline: false };
                return { text: `Seen ${Math.floor(mins/60)}h ago`, isOnline: false };
            };

            const getGreeting = () => {
                const hour = currentTime.getHours();
                const name = partnerId.charAt(0).toUpperCase() + partnerId.slice(1);
                if (hour < 12) return `Good Morning, ${name}`;
                if (hour < 18) return `Good Afternoon, ${name}`;
                return `Good Evening, ${name}`;
            };

            const currentMoodData = MOODS.find(m => m.id === (partner?.mood || 'love'));
            const status = getOnlineStatus();
            
            // Interaction States
            const bothPressing = isPressing && partner?.isPressing;
            const onePressing = (isPressing || partner?.isPressing) && !bothPressing;

            if (loading) {
                return (
                    <div className="fixed inset-0 bg-slate-950 flex flex-col items-center justify-center gap-6">
                        <div className="relative">
                            <Icon name="Heart" size={80} className="text-rose-500 animate-pulse" fill="currentColor" />
                        </div>
                        <h1 className="text-3xl font-serif text-white/90 tracking-widest">SUNAHH</h1>
                        <p className="text-[10px] text-white/40 uppercase tracking-[0.4em] font-medium">Connecting Hearts</p>
                    </div>
                );
            }

            return (
                <div className={`h-screen flex flex-col relative transition-colors duration-1000 ${currentMoodData?.bg || 'bg-slate-950'} text-white`}>
                    
                    {/* Background Ambient Glow */}
                    <div className="fixed inset-0 pointer-events-none opacity-40 transition-opacity duration-1000">
                        <div className={`absolute top-[-10%] left-[-10%] w-[70%] h-[70%] blur-[120px] rounded-full bg-gradient-to-br ${currentMoodData?.color || 'from-blue-500 to-purple-500'}`} />
                        <div className="absolute bottom-[-10%] right-[-10%] w-[70%] h-[70%] blur-[120px] rounded-full bg-gradient-to-tl from-pink-500 to-rose-500" />
                    </div>

                    <header className="relative z-10 px-6 pt-12 pb-2 flex justify-between items-center shrink-0">
                        <div>
                            <h1 className="text-3xl font-serif font-medium bg-clip-text text-transparent bg-gradient-to-r from-white via-white to-white/70 capitalize">
                                {partnerId}
                            </h1>
                            <div className="flex items-center gap-2 mt-1">
                                <div className={`flex items-center gap-2 transition-all duration-500`}>
                                    <div className={`w-2 h-2 rounded-full ${status.isOnline ? 'bg-green-400 shadow-[0_0_8px_rgba(74,222,128,0.6)]' : 'bg-white/20'}`}></div>
                                    <span className={`text-xs tracking-wide ${status.isOnline ? 'text-green-300 font-medium' : 'text-white/40'}`}>
                                        {status.text}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <button onClick={() => setView('settings')} className="p-3 glass rounded-2xl active:scale-95 transition-transform"><Icon name="Smile" size={24} /></button>
                    </header>

                    <main className="flex-1 relative z-10 overflow-y-auto pb-32 px-6 no-scrollbar">
                        {view === 'home' && (
                            <div className="h-full flex flex-col items-center justify-center gap-12 view-transition">
                                {showInstallTip && (
                                    <div className="glass-high p-4 rounded-2xl flex items-center gap-4 text-xs animate-pulse">
                                        <Icon name="Smartphone" className="text-amber-300 shrink-0" size={20} />
                                        <p>Tap Share ‚Üí <strong>Add to Home Screen</strong> for the full experience.</p>
                                    </div>
                                )}
                                
                                <div className="text-center space-y-1">
                                    <p className="text-sm font-serif italic text-white/50">{getGreeting()}</p>
                                    <p className="text-xs text-white/30 uppercase tracking-widest">{status.isOnline ? "She is here with you" : "She is thinking of you"}</p>
                                </div>

                                {/* THE INTERACTIVE HEART */}
                                <div className="relative group cursor-pointer select-none">
                                    {/* BOTH PRESSING EFFECTS */}
                                    {bothPressing && (
                                        <>
                                            <div className="absolute inset-0 animate-ping rounded-full bg-amber-400/30 scale-150 duration-700" />
                                            <div className="absolute inset-0 animate-pulse rounded-full border-4 border-amber-300 scale-110 duration-100" />
                                        </>
                                    )}

                                    {/* SINGLE PRESSING EFFECTS */}
                                    {onePressing && (
                                        <div className="absolute inset-0 animate-ping rounded-full bg-rose-500/20 scale-150 duration-1000" />
                                    )}
                                    
                                    <button
                                        onMouseDown={() => setIsPressing(true)}
                                        onMouseUp={() => setIsPressing(false)}
                                        onTouchStart={() => setIsPressing(true)}
                                        onTouchEnd={() => setIsPressing(false)}
                                        className={`relative w-64 h-64 rounded-full glass-high flex items-center justify-center transition-all duration-300 
                                        ${bothPressing ? 'scale-110 shadow-[0_0_80px_rgba(251,191,36,0.6)] border-2 border-amber-200/50' : ''}
                                        ${onePressing ? 'animate-heart shadow-[0_0_50px_rgba(251,113,133,0.3)]' : 'shadow-2xl'}`}
                                    >
                                        {bothPressing ? (
                                             <Icon name="Zap" size={100} className="text-amber-300 animate-[spin_3s_linear_infinite] drop-shadow-[0_0_15px_rgba(251,191,36,0.8)]" fill="currentColor" />
                                        ) : (
                                             <Icon name="Heart" size={90} fill={(isPressing || partner?.isPressing) ? 'currentColor' : 'none'} className={`transition-colors duration-500 ${isPressing || partner?.isPressing ? 'text-rose-400' : 'text-white/10'}`} />
                                        )}
                                        
                                        {/* Floating Mood Icon */}
                                        <div className="absolute -top-2 -right-2 w-12 h-12 glass rounded-full flex items-center justify-center text-2xl animate-bounce">
                                            {partner?.mood ? MOODS.find(m => m.id === partner.mood)?.icon : '‚ù§Ô∏è'}
                                        </div>
                                    </button>

                                    {/* Dynamic Status Text */}
                                    <div className="absolute -bottom-16 left-0 right-0 text-center transition-all duration-300 h-8">
                                         {bothPressing ? (
                                             <p className="text-amber-300 font-bold tracking-widest text-lg animate-pulse drop-shadow-lg">‚ö° CONNECTED! ‚ö°</p>
                                         ) : onePressing ? (
                                             <p className="text-rose-300/80 font-medium tracking-wide text-sm animate-pulse">
                                                {isPressing ? "Sending your touch..." : "Feeling her touch..."}
                                             </p>
                                         ) : null}
                                    </div>
                                </div>
                                
                                <div className="grid grid-cols-2 gap-4 w-full max-w-sm">
                                    <div className="glass p-5 rounded-3xl flex items-center gap-4 hover:bg-white/5 transition-colors">
                                        <Icon name="Clock" className="text-blue-300" size={20} />
                                        <div>
                                            <div className="text-[10px] text-white/30 uppercase tracking-wider mb-1">Local Time</div>
                                            <div className="text-sm font-medium font-serif">{currentTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
                                        </div>
                                    </div>
                                    <div className="glass p-5 rounded-3xl flex items-center gap-4 hover:bg-white/5 transition-colors">
                                        <Icon name="MapPin" className="text-rose-300" size={20} />
                                        <div>
                                            <div className="text-[10px] text-white/30 uppercase tracking-wider mb-1">Distance</div>
                                            <div className="text-sm font-medium font-serif">Heartbeats away</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {view === 'chat' && (
                            <div className="flex flex-col h-full pt-4 view-transition relative">
                                <div className="flex-1 space-y-4 mb-20 overflow-y-auto no-scrollbar">
                                    {messages.map(m => (
                                        <div key={m.id} className={`flex flex-col ${m.sender === myId ? 'items-end' : 'items-start'}`}>
                                            <div className={`relative px-5 py-3.5 max-w-[85%] rounded-3xl text-[15px] leading-relaxed shadow-sm transition-all hover:scale-[1.01] ${
                                                m.sender === myId 
                                                ? 'bg-white text-slate-900 rounded-tr-md font-medium' 
                                                : 'glass-high rounded-tl-md border-white/10'
                                            }`}>
                                                {m.text}
                                                {m.sender !== myId && (
                                                    <button onClick={() => handleListenToMessage(m.id, m.text)} className="ml-2 inline-flex align-middle p-1.5 rounded-full bg-black/10 hover:bg-black/20 text-white/60 transition-colors">
                                                        <Icon name="Volume2" size={12} />
                                                    </button>
                                                )}
                                            </div>
                                            <span className="text-[10px] text-white/20 mt-1.5 px-2">{m.timestamp?.toDate ? m.timestamp.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '...'}</span>
                                        </div>
                                    ))}
                                    
                                    {/* Typing Indicator */}
                                    {partner?.isTyping && (
                                        <div className="flex items-center gap-1 px-4 py-2 glass rounded-2xl w-fit animate-pulse">
                                            <span className="text-[10px] text-white/50 mr-2 uppercase tracking-wide">Sana is typing</span>
                                            <div className="typing-dot bg-white/50"></div>
                                            <div className="typing-dot bg-white/50"></div>
                                            <div className="typing-dot bg-white/50"></div>
                                        </div>
                                    )}
                                    <div className="h-4"></div>
                                </div>

                                <div className="fixed bottom-24 left-6 right-6 z-20">
                                    <div className="glass-high p-2 rounded-[2rem] flex items-center gap-2 shadow-2xl backdrop-blur-xl">
                                        <input 
                                            value={inputMsg} onChange={e => setInputMsg(e.target.value)} 
                                            onKeyDown={(e) => e.key === 'Enter' && handleSendMessage()}
                                            placeholder={`Whisper to ${partnerId}...`} 
                                            className="flex-1 bg-transparent px-5 py-3 outline-none text-sm placeholder:text-white/30 text-white font-medium"
                                        />
                                        <button onClick={handleEnhanceWhisper} className="p-3 text-amber-200 hover:bg-white/10 rounded-full transition-all active:scale-95">
                                            {isEnhancing ? <Icon name="Loader2" className="animate-spin" size={20} /> : <Icon name="Wand2" size={20} />}
                                        </button>
                                        <button onClick={handleSendMessage} className="bg-white text-black p-3 rounded-full shadow-lg hover:bg-white/90 active:scale-90 transition-all">
                                            <Icon name="Send" size={20} />
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {view === 'dreams' && (
                            <div className="space-y-8 pt-6 view-transition">
                                <div className="glass-high p-8 rounded-[2.5rem] space-y-6 shadow-xl relative overflow-hidden">
                                    <div className="absolute top-0 right-0 p-32 bg-amber-500/10 blur-[60px] rounded-full pointer-events-none"></div>
                                    <h2 className="text-xl font-serif font-medium flex items-center gap-3 relative z-10">
                                        <Icon name="Sparkles" className="text-amber-200" size={24} /> 
                                        Dream Together
                                    </h2>
                                    <textarea 
                                        value={dreamPrompt} onChange={e => setDreamPrompt(e.target.value)}
                                        placeholder="Describe a moment you want to share..."
                                        className="w-full bg-white/5 rounded-2xl p-4 text-sm border border-white/10 h-28 outline-none resize-none placeholder:text-white/20 focus:border-white/20 transition-colors"
                                    />
                                    <button onClick={handleGenerateDream} disabled={isGeneratingDream} className="w-full bg-white text-black font-semibold py-4 rounded-2xl disabled:opacity-50 hover:bg-slate-100 transition-colors shadow-lg">
                                        {isGeneratingDream ? 'Painting your dream...' : 'Visualize This Moment'}
                                    </button>
                                </div>
                                
                                <div className="grid gap-8">
                                    {dreams.map(d => (
                                        <div key={d.id} className="glass rounded-[2.5rem] overflow-hidden shadow-2xl group">
                                            <div className="relative">
                                                <img src={d.imageUrl} className="w-full aspect-[4/5] object-cover transition-transform duration-1000 group-hover:scale-105" />
                                                <div className="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent opacity-60"></div>
                                                <div className="absolute bottom-0 left-0 right-0 p-6">
                                                    <p className="text-sm font-serif italic text-white/90 leading-relaxed">"{d.prompt}"</p>
                                                    <p className="text-[10px] text-white/40 mt-2 uppercase tracking-widest">Dreamt by {d.creator}</p>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {view === 'settings' && (
                            <div className="space-y-10 pt-6 view-transition">
                                <section>
                                    <h3 className="text-[10px] font-bold text-white/30 uppercase tracking-[0.3em] mb-8 px-2 text-center">Your Heart's Mood</h3>
                                    <div className="grid grid-cols-2 gap-4">
                                        {MOODS.map(m => (
                                            <button 
                                                key={m.id} onClick={() => setMyMood(m.id)}
                                                className={`flex items-center gap-4 p-5 rounded-[2rem] border transition-all duration-300 ${myMood === m.id ? 'bg-white text-slate-900 border-white shadow-[0_0_30px_rgba(255,255,255,0.15)] scale-[1.02]' : 'glass border-white/5 hover:bg-white/5'}`}
                                            >
                                                <span className="text-3xl filter drop-shadow-md">{m.icon}</span>
                                                <span className="text-sm font-semibold capitalize tracking-wide">{m.id}</span>
                                            </button>
                                        ))}
                                    </div>
                                </section>
                                <section className="p-8 rounded-[2.5rem] border border-rose-500/20 bg-rose-500/5 shadow-inner text-center">
                                    <h3 className="font-serif font-medium text-rose-300 mb-2 text-lg">Identity Portal</h3>
                                    <p className="text-xs text-rose-200/50 mb-6 leading-relaxed">You are currently logged in as <br/><strong className="text-base uppercase tracking-widest text-white mt-1 block">{myId}</strong></p>
                                    <button onClick={() => window.location.hash = myId === 'abhishek' ? 'sana' : 'abhishek'} className="px-8 py-3 glass rounded-full text-xs font-bold uppercase tracking-widest text-rose-200 hover:bg-white/10 transition-all">Switch User</button>
                                </section>
                            </div>
                        )}
                    </main>

                    <nav className="fixed bottom-8 left-1/2 -translate-x-1/2 glass-high p-2 rounded-full flex gap-3 z-50 shadow-[0_10px_40px_rgba(0,0,0,0.5)] border border-white/10">
                        <button onClick={() => setView('home')} className={`p-5 rounded-full transition-all duration-300 ${view === 'home' ? 'bg-white text-slate-900 shadow-lg scale-110' : 'text-white/60 hover:text-white'}`}><Icon name="Heart" size={24} fill={view === 'home' ? 'currentColor' : 'none'} /></button>
                        <button onClick={() => setView('chat')} className={`relative p-5 rounded-full transition-all duration-300 ${view === 'chat' ? 'bg-white text-slate-900 shadow-lg scale-110' : 'text-white/60 hover:text-white'}`}>
                            <Icon name="MessageCircle" size={24} />
                            {partner?.isTyping && view !== 'chat' && <div className="absolute top-3 right-3 w-2.5 h-2.5 bg-amber-400 rounded-full animate-bounce shadow-lg"></div>}
                        </button>
                        <button onClick={() => setView('dreams')} className={`p-5 rounded-full transition-all duration-300 ${view === 'dreams' ? 'bg-white text-slate-900 shadow-lg scale-110' : 'text-white/60 hover:text-white'}`}><Icon name="Cloud" size={24} /></button>
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>