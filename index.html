import React, { useState, useEffect, useRef, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, 
  doc, 
  setDoc, 
  onSnapshot, 
  collection, 
  addDoc, 
  serverTimestamp,
  query,
  orderBy
} from 'firebase/firestore';
import { 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken, 
  onAuthStateChanged 
} from 'firebase/auth';
import { 
  Heart, 
  MessageCircle, 
  Cloud, 
  Send, 
  Mic,
  Smile,
  Play,
  Pause,
  CheckCheck,
  Lock,
  Sparkles,
  Zap,
  Sun,
  Star,
  Calendar,
  Coffee,
  Ghost,
  Wind,
  Flame,
  User,
  Infinity as InfinityIcon,
  Anchor,
  Compass,
  Trophy,
  Activity,
  Layers
} from 'lucide-react';

// --- CONFIG & CONSTANTS ---
const firebaseConfig = {
  apiKey: "AIzaSyBxm9XNECnnua2ygeOSfQUQAoon8VBabgQ",
  authDomain: "sunahh-43bb8.firebaseapp.com",
  projectId: "sunahh-43bb8",
  storageBucket: "sunahh-43bb8.appspot.com",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'sunahh-pro';

// --- THE ABHISANA TIMELINE ---
const START_DATE = new Date('2024-11-03'); 

const MOODS = [
  { id: 'happy', icon: 'âœ¨', label: 'Radiant', bg: 'from-amber-50 via-white to-orange-50', color: 'text-amber-600' },
  { id: 'calm', icon: 'ðŸƒ', label: 'Peaceful', bg: 'from-emerald-50 via-white to-teal-50', color: 'text-emerald-600' },
  { id: 'cozy', icon: 'â˜•', label: 'Warm', bg: 'from-orange-50 via-white to-rose-50', color: 'text-orange-600' },
  { id: 'sleepy', icon: 'â˜ï¸', label: 'Dreamy', bg: 'from-slate-100 via-white to-indigo-100', color: 'text-slate-600' },
  { id: 'missing', icon: 'ðŸ’œ', label: 'Longing', bg: 'from-purple-50 via-white to-fuchsia-50', color: 'text-purple-600' },
];

const App = () => {
  const [loading, setLoading] = useState(true);
  const [user, setUser] = useState(null);
  const [partner, setPartner] = useState(null);
  const [messages, setMessages] = useState([]);
  const [moments, setMoments] = useState([]);
  const [view, setView] = useState('home'); 
  const [isPressing, setIsPressing] = useState(false);
  const [inputMsg, setInputMsg] = useState('');
  const [myMood, setMyMood] = useState('happy');
  const [isRecording, setIsRecording] = useState(false);
  const [currentlyPlaying, setCurrentlyPlaying] = useState(null);
  const [permissionError, setPermissionError] = useState(false);
  const [sharedPromise, setSharedPromise] = useState("Holding space for us...");

  const messagesEndRef = useRef(null);
  const mediaRecorder = useRef(null);
  const audioChunks = useRef([]);

  const myId = useMemo(() => {
    const hash = window.location.hash.replace('#', '').toLowerCase();
    return hash === 'abhishek' ? 'abhishek' : 'sana';
  }, []);
  const partnerId = myId === 'abhishek' ? 'sana' : 'abhishek';

  // --- IDENTITY ---
  const myName = myId === 'abhishek' ? 'Abhishek' : 'Sana';
  const partnerName = partnerId === 'abhishek' ? 'Abhishek' : 'Sana';
  
  // --- COUNTERS ---
  const daysTogether = useMemo(() => {
    const diff = Math.abs(new Date() - START_DATE);
    return Math.floor(diff / (1000 * 60 * 60 * 24));
  }, []);

  // --- AUTH & DATA INIT ---
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) {
        setUser({ uid: 'local-' + myId });
      }
    };
    initAuth();
    const unsub = onAuthStateChanged(auth, (u) => u && setUser(u));
    return () => unsub();
  }, [myId]);

  useEffect(() => {
    if (!user) return;
    const updatePresence = async () => {
      try {
        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'presence', myId), {
          uid: user.uid,
          lastSeen: serverTimestamp(),
          isPressing,
          mood: myMood,
          id: myId,
          isTyping: inputMsg.length > 0,
          currentView: view
        }, { merge: true });
      } catch (err) {
        if (err.code === 'permission-denied') setPermissionError(true);
      }
    };
    const interval = setInterval(updatePresence, 2000);
    return () => clearInterval(interval);
  }, [user, isPressing, myMood, inputMsg, myId, view]);

  useEffect(() => {
    if (!user) return;
    
    const unsubPartner = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'presence', partnerId), (doc) => setPartner(doc.data()));
    
    const msgsQuery = collection(db, 'artifacts', appId, 'public', 'data', 'messages');
    const unsubMsgs = onSnapshot(msgsQuery, (snap) => {
      const msgs = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      msgs.sort((a,b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
      setMessages(msgs);
      setTimeout(() => messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }), 100);
    });

    const unsubMoments = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'moments'), (snap) => {
      const mms = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      mms.sort((a,b) => (b.savedAt?.seconds || 0) - (a.savedAt?.seconds || 0));
      setMoments(mms);
    });

    const unsubPromise = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'global', 'promise'), (d) => {
      if(d.exists()) setSharedPromise(d.data().text);
    });

    setTimeout(() => setLoading(false), 1000);
    return () => { unsubPartner(); unsubMsgs(); unsubMoments(); unsubPromise(); };
  }, [user, partnerId]);

  // --- ACTIONS ---
  const handleSendMessage = async (customText = null) => {
    const text = customText || inputMsg;
    if (!text.trim()) return;
    setInputMsg('');
    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), {
      text, sender: myId, timestamp: serverTimestamp(), isNudge: !!customText
    });
  };

  const updatePromise = async () => {
    const newP = prompt("Update our shared promise:", sharedPromise);
    if(newP) {
      await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'global', 'promise'), {
        text: newP, updatedBy: myId, timestamp: serverTimestamp()
      });
    }
  };

  const sparkMoment = async (msg) => {
    if (navigator.vibrate) navigator.vibrate(50);
    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'moments'), {
      text: msg.text, sender: msg.sender, savedAt: serverTimestamp()
    });
  };

  // --- AUDIO ---
  const startRecording = async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder.current = new MediaRecorder(stream);
      audioChunks.current = [];
      mediaRecorder.current.ondataavailable = (e) => audioChunks.current.push(e.data);
      mediaRecorder.current.onstop = handleSendVoice;
      mediaRecorder.current.start();
      setIsRecording(true);
      if(navigator.vibrate) navigator.vibrate(60);
    } catch (err) { alert("Mic access required for whispers."); }
  };

  const stopRecording = () => {
    if (mediaRecorder.current && isRecording) {
      mediaRecorder.current.stop();
      setIsRecording(false);
    }
  };

  const handleSendVoice = async () => {
    if (audioChunks.current.length === 0) return;
    const audioBlob = new Blob(audioChunks.current, { type: 'audio/webm' });
    const reader = new FileReader();
    reader.readAsDataURL(audioBlob);
    reader.onloadend = async () => {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), {
        audio: reader.result, sender: myId, timestamp: serverTimestamp()
      });
    };
  };

  const playVoice = (audioBase64, msgId) => {
    if (currentlyPlaying === msgId) return;
    const audio = new Audio(audioBase64);
    setCurrentlyPlaying(msgId);
    audio.play();
    audio.onended = () => setCurrentlyPlaying(null);
  };

  // --- UI HELPERS ---
  const partnerMoodData = useMemo(() => MOODS.find(m => m.id === partner?.mood) || MOODS[0], [partner?.mood]);
  const bothPressing = isPressing && partner?.isPressing;
  const partnerOnline = partner?.lastSeen && (Date.now() - partner.lastSeen.seconds * 1000 < 60000);

  if (loading) return (
    <div className="fixed inset-0 bg-white flex flex-col items-center justify-center z-[100]">
      <div className="relative mb-8 flex flex-col items-center">
        <Heart size={60} className="text-sky-100 animate-pulse" fill="currentColor" />
        <h2 className="text-[16px] font-black uppercase tracking-[1.1em] text-slate-400 mt-6 ml-4">Sunahh</h2>
        <p className="mt-4 text-[9px] font-bold text-slate-200 uppercase tracking-widest">Since Nov 3, 2024</p>
      </div>
    </div>
  );

  return (
    <div className={`fixed inset-0 flex flex-col transition-all duration-1000 font-sans overflow-hidden bg-gradient-to-br ${bothPressing ? 'from-white via-orange-50 to-white' : partnerMoodData.bg}`}>
      
      {/* Decorative Atmosphere */}
      <div className="absolute inset-0 pointer-events-none opacity-40 overflow-hidden">
        <div className="absolute top-[-20%] left-[-20%] w-[120%] h-[120%] rounded-full blur-[140px] bg-white animate-soft" />
      </div>

      {/* Main App Container - Responsive Max Width */}
      <div className="relative z-10 w-full h-full max-w-5xl mx-auto flex flex-col md:border-x md:border-white/20 md:shadow-2xl bg-white/5 backdrop-blur-sm">
        
        {/* Sanctuary Header */}
        <header className="flex-none px-6 py-5 md:py-8 flex justify-between items-center bg-white/20 backdrop-blur-3xl border-b border-white/40 pt-[max(env(safe-area-inset-top),1.5rem)]">
          <div className="flex items-center gap-5">
            <div className="relative group cursor-pointer" onClick={() => setView('settings')}>
              <div className={`w-14 h-14 md:w-16 md:h-16 rounded-[1.8rem] bg-white shadow-2xl flex items-center justify-center text-4xl border-2 border-white transition-all duration-700 ${partner?.isPressing ? 'scale-110 rotate-12' : ''}`}>
                {partnerMoodData.icon}
              </div>
              {partnerOnline && (
                <div className="absolute -bottom-1 -right-1 w-5 h-5 bg-emerald-400 border-[4px] border-white rounded-full shadow-lg" />
              )}
            </div>
            <div>
              <h1 className="font-serif font-black text-slate-900 text-xl md:text-2xl capitalize tracking-tighter leading-none">
                My {partnerName}
              </h1>
              <p className={`text-[9px] md:text-[10px] mt-2 uppercase font-black tracking-[0.3em] transition-colors ${partner?.isTyping ? 'text-sky-500' : 'text-slate-400/60'}`}>
                {partner?.isTyping ? "Whispering..." : (partnerOnline ? "Breathing with you" : "Resting quietly")}
              </p>
            </div>
          </div>
          <div className="flex gap-2.5">
             <button onClick={() => handleSendMessage(`â­ Close your eyes, I'm thinking of you...`)} className="w-11 h-11 md:w-12 md:h-12 flex items-center justify-center rounded-2xl bg-white/70 text-rose-300 border border-white shadow-sm active:scale-75 transition-all">
               <Star size={20} fill="currentColor" />
             </button>
             <button onClick={() => setView('settings')} className="w-11 h-11 md:w-12 md:h-12 flex items-center justify-center rounded-2xl bg-white/70 text-slate-400 border border-white shadow-sm active:scale-75 transition-all">
               <Smile size={22} />
             </button>
          </div>
        </header>

        {/* Viewport Content */}
        <main className="flex-1 relative overflow-hidden flex flex-col">
          
          {/* HOME: The AbhiSana Connection */}
          {view === 'home' && (
            <div className="flex-1 flex flex-col items-center justify-between p-8 md:p-12 pb-20 view-transition overflow-y-auto no-scrollbar">
              <div className="text-center space-y-4 md:mt-4">
                <div className="inline-flex items-center gap-3 px-6 py-2.5 bg-white/70 rounded-full border border-white shadow-lg">
                  <Flame size={16} className="text-orange-400 animate-pulse" />
                  <span className="text-[11px] font-black uppercase tracking-[0.4em] text-slate-500">The Soul Link is Active</span>
                </div>
                <h2 className="font-serif text-4xl md:text-6xl font-black text-slate-900 tracking-tighter leading-tight">Welcome Home, {myName}</h2>
                <p className="text-slate-400 text-sm md:text-base font-serif italic px-6 md:px-24 leading-relaxed max-w-2xl mx-auto">
                  {partner?.isPressing ? `${partnerName} is holding her screen, reaching across the miles...` : `We've shared ${daysTogether} beautiful days since November 3rd.`}
                </p>
              </div>

              {/* Central Connection Point */}
              <div className="relative my-8 md:my-10">
                {bothPressing && <div className="absolute inset-[-140px] rounded-full bg-white blur-[110px] animate-pulse opacity-100" />}
                <button
                  onMouseDown={() => setIsPressing(true)} onMouseUp={() => setIsPressing(false)}
                  onTouchStart={() => setIsPressing(true)} onTouchEnd={() => setIsPressing(false)}
                  className={`relative w-72 h-72 md:w-96 md:h-96 rounded-[6rem] md:rounded-[8rem] flex flex-col items-center justify-center transition-all duration-1000 active:scale-90 shadow-2xl
                    ${bothPressing ? 'bg-white shadow-[0_0_180px_rgba(255,255,255,1)] scale-110 rotate-6' : 'bg-white/95 border-2 border-white'}
                  `}
                >
                  <Heart size={bothPressing ? 130 : 100} fill={isPressing || partner?.isPressing ? "#38bdf8" : "none"} 
                    className={`transition-all duration-1000 ${isPressing || partner?.isPressing ? 'text-sky-400 scale-125' : 'text-slate-100 opacity-40'}`} 
                  />
                  <div className="absolute bottom-12 md:bottom-16">
                     <span className={`text-[11px] md:text-[13px] font-black uppercase tracking-[0.6em] transition-all ${bothPressing ? 'text-sky-400 opacity-100 animate-pulse' : 'text-slate-200 opacity-50'}`}>
                       {bothPressing ? "In Harmony" : "Touch for Warmth"}
                     </span>
                  </div>
                </button>
              </div>
              
              <div className="w-full max-w-xl flex flex-col gap-4 md:gap-6">
                 <div onClick={updatePromise} className="w-full bg-white/70 p-7 rounded-[3rem] border-2 border-white shadow-xl flex flex-col items-center text-center cursor-pointer active:scale-95 transition-all group overflow-hidden">
                    <Anchor size={18} className="text-sky-300 mb-4 group-hover:rotate-45 transition-transform" />
                    <p className="text-[10px] font-black text-slate-300 uppercase tracking-[0.4em] mb-2">Today's Sacred Vow</p>
                    <p className="text-base font-serif italic font-black text-slate-800 px-6">"{sharedPromise}"</p>
                 </div>

                 <div className="w-full bg-white/50 p-6 rounded-[2.8rem] border border-white flex flex-col items-center text-center shadow-sm">
                    <InfinityIcon size={20} className="text-rose-300 mb-2" />
                    <p className="text-[9px] font-black text-slate-300 uppercase tracking-widest mb-1">Our Journey Together</p>
                    <p className="text-xl font-black text-slate-800">{daysTogether} Days</p>
                 </div>
              </div>
            </div>
          )}

          {/* TALK: The Whisper Channel */}
          {view === 'chat' && (
            <div className="flex-1 flex flex-col h-full view-transition bg-white/5 backdrop-blur-xl relative">
              <div className="flex-1 overflow-y-auto px-6 md:px-24 py-12 space-y-12 no-scrollbar">
                {messages.length === 0 && (
                  <div className="h-full flex flex-col items-center justify-center opacity-30 text-slate-400">
                    <Wind size={50} className="mb-8 animate-soft" />
                    <p className="text-lg font-serif italic text-center px-20 leading-relaxed max-w-md">
                      Let the words flow, {myName}. Your {partnerName} is listening to every whisper.
                    </p>
                  </div>
                )}
                {messages.map((m) => (
                  <div key={m.id} className={`flex flex-col ${m.sender === myId ? 'items-end' : 'items-start'}`}>
                    <div className={`max-w-[85%] md:max-w-[65%] px-7 py-5 shadow-2xl relative group border transition-all duration-700 ${
                      m.sender === myId 
                      ? 'bg-slate-900 text-white border-slate-800 rounded-[35px] rounded-br-none' 
                      : 'bg-white text-slate-800 border-slate-100 rounded-[35px] rounded-bl-none shadow-lg'
                    }`}>
                      {m.text && <p className={`text-[16px] font-medium leading-relaxed ${m.isNudge ? 'text-sky-300 italic font-black text-lg' : ''}`}>{m.text}</p>}
                      {m.audio && (
                        <button onClick={() => playVoice(m.audio, m.id)} className="flex items-center gap-6 py-2">
                          <div className={`p-4 rounded-full ${m.sender === myId ? 'bg-white/10' : 'bg-slate-50 border border-slate-100'}`}>
                            {currentlyPlaying === m.id ? <Pause size={22} fill="currentColor" /> : <Play size={22} fill="currentColor" />}
                          </div>
                          <div className="flex gap-2.5 h-10 items-center">
                            {[1,2,3,4,5,6,7,8,9,10].map(i => <div key={i} className={`w-1 rounded-full bg-current transition-all duration-500 ${currentlyPlaying === m.id ? 'animate-pulse h-10 opacity-70' : 'h-4 opacity-10'}`} style={{animationDelay: `${i*0.08}s`}} />)}
                          </div>
                        </button>
                      )}
                      <div className="flex items-center justify-between gap-10 mt-5">
                         <button onClick={() => sparkMoment(m)} className="opacity-0 group-hover:opacity-100 p-2.5 bg-amber-50 rounded-2xl transition-all hover:scale-125 shadow-sm">
                           <Star size={16} className="text-amber-400" fill="currentColor" />
                         </button>
                         <div className="flex items-center gap-2 opacity-30">
                           <span className="text-[10px] font-black uppercase tracking-widest">
                             {m.timestamp ? new Date(m.timestamp.seconds * 1000).toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' }) : '...'}
                           </span>
                           {m.sender === myId && <CheckCheck size={16} strokeWidth={4} />}
                         </div>
                      </div>
                    </div>
                  </div>
                ))}
                <div ref={messagesEndRef} />
              </div>

              {/* Chat Input Bar */}
              <div className="flex-none p-6 md:px-24 bg-white/70 backdrop-blur-3xl border-t border-white/60 flex items-center gap-5 pb-[max(2rem,env(safe-area-inset-bottom))]">
                <div className="flex-1 bg-white/50 rounded-[3.5rem] border-2 border-slate-100 px-8 py-1 flex items-center gap-3 shadow-inner group focus-within:bg-white transition-all">
                  <input 
                    value={inputMsg} 
                    onChange={e => setInputMsg(e.target.value)} 
                    onKeyDown={e => e.key === 'Enter' && handleSendMessage()}
                    placeholder={`Whisper to ${partnerName}...`} 
                    className="flex-1 py-5 text-[16px] text-slate-800 bg-transparent outline-none font-bold placeholder:text-slate-300" 
                  />
                </div>
                {inputMsg.length > 0 ? (
                  <button onClick={() => handleSendMessage()} className="p-6 bg-slate-900 text-white rounded-[2.2rem] shadow-2xl active:scale-90 transition-all border-2 border-slate-800">
                    <Send size={24} strokeWidth={3} />
                  </button>
                ) : (
                  <button onMouseDown={startRecording} onMouseUp={stopRecording} onTouchStart={startRecording} onTouchEnd={stopRecording}
                    className={`p-6 rounded-[2.2rem] transition-all duration-300 shadow-2xl active:scale-110 border-2 ${isRecording ? 'bg-rose-500 text-white border-rose-400 scale-125' : 'bg-white text-sky-400 border-white shadow-sky-50'}`}
                  >
                    <Mic size={28} />
                  </button>
                )}
              </div>
            </div>
          )}

          {/* SPARKS: The Shared Gallery */}
          {view === 'dreams' && (
            <div className="flex-1 overflow-y-auto p-10 md:p-24 space-y-16 no-scrollbar view-transition bg-white/5 backdrop-blur-sm">
              <div className="text-center py-4">
                <h2 className="font-serif text-6xl font-black text-slate-900 tracking-tighter">AbhiSana Wall</h2>
                <p className="text-[11px] uppercase font-black tracking-[0.8em] text-slate-300 mt-6">Captured Forever</p>
              </div>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-12 pb-40">
                {moments.length === 0 && (
                  <div className="md:col-span-2 p-24 bg-white/40 rounded-[5rem] border-2 border-white text-center shadow-xl">
                    <Trophy size={50} className="mx-auto text-sky-200 mb-8" />
                    <p className="italic text-slate-500 text-lg font-serif px-10 leading-relaxed">No shared sparks yet. Press the star icon in your talk to pin a memory here.</p>
                  </div>
                )}
                {moments.map((mm, i) => (
                  <div key={mm.id} style={{ transform: `rotate(${i % 2 === 0 ? '-2deg' : '2deg'})` }} className="p-8 bg-white rounded-lg shadow-2xl border border-slate-50 group hover:rotate-0 hover:scale-105 transition-all duration-700 cursor-pointer">
                    <div className="aspect-square bg-slate-50/50 mb-8 flex items-center justify-center p-12 border border-slate-100 relative group-hover:bg-white transition-colors">
                       <Sparkles size={20} className="absolute top-6 right-6 text-amber-400 opacity-20 group-hover:opacity-100 transition-opacity" />
                       <p className="text-2xl font-serif italic text-slate-800 leading-tight text-center font-black">"{mm.text}"</p>
                    </div>
                    <div className="flex justify-between items-end px-4">
                       <div className="space-y-1 text-left">
                          <p className="text-[11px] font-black text-slate-900 uppercase tracking-[0.2em]">Written by {mm.sender}</p>
                          <p className="text-[9px] font-bold text-slate-300 uppercase tracking-widest">
                            {mm.savedAt ? new Date(mm.savedAt.seconds * 1000).toLocaleDateString(undefined, {month:'long', day:'numeric', year:'numeric'}) : 'Soul Sync'}
                          </p>
                       </div>
                       <Heart size={24} className="text-rose-100 fill-rose-100 group-hover:scale-150 transition-transform" />
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* PORTAL SETTINGS */}
          {view === 'settings' && (
            <div className="flex-1 p-10 md:px-32 space-y-14 view-transition pt-16 overflow-y-auto no-scrollbar">
              <section className="text-center">
                <h3 className="text-[12px] font-black text-slate-400 uppercase tracking-[0.6em] mb-14">Inner Resonance</h3>
                <div className="grid grid-cols-2 md:grid-cols-3 gap-8">
                  {MOODS.map(m => (
                    <button 
                      key={m.id} onClick={() => setMyMood(m.id)} 
                      className={`p-10 rounded-[4rem] transition-all active:scale-95 border-2 flex flex-col items-center gap-5 ${
                        myMood === m.id ? 'bg-white border-white shadow-2xl scale-110' : 'bg-white/20 border-transparent opacity-30 grayscale'
                      }`}
                    >
                      <span className="text-6xl transition-transform group-active:scale-150">{m.icon}</span>
                      <span className="text-[10px] font-black tracking-widest text-slate-600 uppercase">{m.label}</span>
                    </button>
                  ))}
                </div>
              </section>
              
              <section className="bg-white/80 p-14 rounded-[5rem] border-2 border-white shadow-2xl space-y-12 text-center max-w-2xl mx-auto mb-20">
                <div className="space-y-8">
                  <p className="text-[12px] font-black text-slate-400 uppercase tracking-[0.6em]">Active Soul</p>
                  <div className="flex items-center justify-center gap-6 bg-slate-50 p-8 rounded-[2.5rem] shadow-inner border border-slate-100 group">
                     <div className="w-16 h-16 rounded-[2rem] flex items-center justify-center text-white bg-slate-900 shadow-xl group-hover:scale-110 transition-transform">
                        <User size={30} />
                     </div>
                     <p className="text-2xl font-black text-slate-900 uppercase tracking-[0.4em]">{myName}</p>
                  </div>
                </div>
                <button 
                  onClick={() => window.location.hash = partnerId} 
                  className="w-full py-8 rounded-[3rem] bg-slate-900 text-white text-[12px] font-black uppercase tracking-[0.6em] shadow-[0_20px_40px_rgba(0,0,0,0.3)] active:scale-95 transition-all"
                >
                  Switch Role
                </button>
              </section>
            </div>
          )}
        </main>

        {/* Global Floating Dock Navigation */}
        <nav className="flex-none bg-white/30 backdrop-blur-3xl border-t border-white/60 pt-6 pb-[max(2.5rem,env(safe-area-inset-bottom))] flex justify-around px-12 z-20 md:px-48">
          {[
            { id: 'home', icon: Coffee, label: 'Sanctuary' },
            { id: 'chat', icon: MessageCircle, label: 'Talk' },
            { id: 'dreams', icon: Cloud, label: 'Sparks' }
          ].map(tab => (
            <button 
              key={tab.id} onClick={() => setView(tab.id)} 
              className={`flex flex-col items-center gap-3 transition-all duration-1000 relative ${view === tab.id ? 'text-slate-950 -translate-y-6' : 'text-slate-300 hover:text-slate-400'}`}
            >
              <div className={`p-6 rounded-[2.2rem] transition-all duration-700 ${view === tab.id ? 'bg-white shadow-[0_20px_50px_rgba(0,0,0,0.1)] scale-125 border border-slate-50' : 'bg-transparent'}`}>
                <tab.icon size={26} strokeWidth={view === tab.id ? 3.5 : 2} fill={view === tab.id ? (tab.id === 'home' ? '#38bdf8' : 'currentColor') : 'none'} />
              </div>
              <span className={`text-[10px] font-black uppercase tracking-[0.5em] transition-all duration-700 ${view === tab.id ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-4'}`}>
                {tab.label}
              </span>
            </button>
          ))}
        </nav>
      </div>
    </div>
  );
};

export default App;