<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Touch</title>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
  body {
    margin: 0;
    min-height: 100vh;
    background: radial-gradient(circle at center, #181818, #0e0e0e);
    font-family: system-ui, sans-serif;
    color: white;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 24px 16px;
    box-sizing: border-box;
  }

  #thumb {
    width: 280px;
    height: 280px;
    border-radius: 50%;
    background: #333;
    transition: background 5s ease, transform 0.3s ease;
    touch-action: none;
  }

  @keyframes breathe {
    0% { transform: scale(1); }
    50% { transform: scale(1.06); }
    100% { transform: scale(1); }
  }

  #thumb.sync {
    animation: breathe 6s infinite;
  }

  #status {
    margin-top: 18px;
    font-size: 15px;
    opacity: 0.75;
    min-height: 20px;
    text-align: center;
  }

  #lastSeen {
    margin-top: 6px;
    font-size: 13px;
    opacity: 0.5;
    min-height: 16px;
  }

  /* MESSAGE INPUT */
  #noteBox {
    width: 100%;
    max-width: 420px;
    margin-top: 28px;
    display: flex;
    gap: 8px;
  }

  #noteInput {
    flex: 1;
    padding: 12px 14px;
    border-radius: 18px;
    border: none;
    font-size: 14px;
    background: #1c1c1c;
    color: white;
    outline: none;
  }

  #mood {
    padding: 12px;
    border-radius: 18px;
    border: none;
    font-size: 14px;
    background: #1c1c1c;
    color: white;
  }

  #noteBox button {
    padding: 12px 16px;
    border-radius: 18px;
    border: none;
    font-size: 16px;
    cursor: pointer;
    background: #2b2b2b;
    color: white;
  }

  /* POPUP */
  #notePopup {
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%) translateY(12px);
    max-width: 80%;
    padding: 18px;
    border-radius: 22px;
    text-align: center;
    font-size: 15px;
    opacity: 0;
    transition: opacity 0.4s ease, transform 0.4s ease;
    pointer-events: none;
  }

  #notePopup.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  .love { background: #ff7aa2; }
  .joy { background: #ffd86b; color: #2b2b2b; }
  .angry { background: #ff4b3a; animation: shake 0.4s 1; }

  @keyframes shake {
    0% { transform: translateX(-50%); }
    25% { transform: translateX(-52%); }
    50% { transform: translateX(-48%); }
    75% { transform: translateX(-52%); }
    100% { transform: translateX(-50%); }
  }
</style>
</head>

<body>

<div id="thumb"></div>
<div id="status"></div>
<div id="lastSeen"></div>

<div id="noteBox">
  <input id="noteInput" placeholder="leave a thought‚Ä¶" />
  <select id="mood">
    <option value="love">‚ù§Ô∏è</option>
    <option value="joy">üòÑ</option>
    <option value="angry">üò°</option>
  </select>
  <button onclick="sendNote()">‚Üí</button>
</div>

<div id="notePopup"><div id="noteText"></div></div>

<script>
  /* ACCESS */
  const allowedUsers = ["abhishek", "sana"];
  const uid = location.hash.replace("#","").toLowerCase();
  if (!allowedUsers.includes(uid)) {
    document.body.innerHTML = "<div style='opacity:.6'>This space is private.</div>";
    throw new Error("blocked");
  }

  /* FIREBASE */
  firebase.initializeApp({
    apiKey: "AIzaSyBxm9XNECnnua2ygeOSfQUQAoon8VBabgQ",
    authDomain: "sunahh-43bb8.firebaseapp.com",
    databaseURL: "https://sunahh-43bb8-default-rtdb.firebaseio.com",
    projectId: "sunahh-43bb8"
  });

  const db = firebase.database();
  const sessionId = "abhishek-sana";

  const myColor =
    uid === "abhishek"
      ? "hsl(210,70%,60%)"
      : "hsl(330,70%,65%)";

  const userRef = db.ref(`sessions/${sessionId}/users/${uid}`);
  const sessionRef = db.ref(`sessions/${sessionId}`);
  const noteRef = sessionRef.child("note");

  const thumb = document.getElementById("thumb");
  const status = document.getElementById("status");
  const lastSeenEl = document.getElementById("lastSeen");
  const popup = document.getElementById("notePopup");
  const noteText = document.getElementById("noteText");

  /* HEARTBEAT (safe) */
  setInterval(() => {
    userRef.update({
      color: myColor,
      lastSeen: Date.now()
    });
  }, 5000);

  /* PRESS & HOLD */
  let pressTimer;

  function startPress() {
    pressTimer = setTimeout(() => {
      userRef.update({ pressed: true });
    }, 1200);
  }

  function endPress() {
    clearTimeout(pressTimer);
    userRef.update({ pressed: false });
  }

  thumb.addEventListener("touchstart", startPress);
  thumb.addEventListener("mousedown", startPress);
  thumb.addEventListener("touchend", endPress);
  thumb.addEventListener("mouseup", endPress);
  thumb.addEventListener("mouseleave", endPress);

  /* HUMAN TIME */
  function timeAgo(ms) {
    if (!ms) return "";
    const diff = Date.now() - ms;
    if (diff < 60000) return "missed you ¬∑ just now";
    const min = Math.floor(diff / 60000);
    if (min < 60) return `missed you ¬∑ ${min} min ago`;
    const hr = Math.floor(min / 60);
    return `missed you ¬∑ ${hr} hour${hr > 1 ? "s" : ""} ago`;
  }

  /* SYNC + LAST SEEN */
  sessionRef.on("value", snap => {
    const users = snap.val()?.users || {};
    const me = users[uid];
    const otherId = uid === "abhishek" ? "sana" : "abhishek";
    const other = users[otherId];

    if (!me) return;

    if (me.pressed && other?.pressed) {
      thumb.style.background =
        `linear-gradient(135deg, ${myColor}, ${other.color})`;
      thumb.classList.add("sync");
      status.textContent = "with you";
      lastSeenEl.textContent = "";
    }
    else if (other?.pressed) {
      thumb.style.background = other.color;
      thumb.classList.remove("sync");
      status.textContent = "here";
      lastSeenEl.textContent = "";
    }
    else if (me.pressed) {
      thumb.style.background = myColor;
      thumb.classList.remove("sync");
      status.textContent = "";
      lastSeenEl.textContent = "";
    }
    else {
      thumb.style.background = "#333";
      thumb.classList.remove("sync");
      status.textContent = "";
      lastSeenEl.textContent = other ? timeAgo(other.lastSeen) : "";
    }
  });

  /* NOTES */
  function sendNote() {
    const text = noteInput.value.trim();
    if (!text) return;

    noteRef.set({
      text,
      mood: mood.value,
      from: uid,
      id: Date.now()
    });

    noteInput.value = "";
  }

  noteRef.on("value", snap => {
    const note = snap.val();
    if (!note || note.from === uid) return;

    popup.className = note.mood + " show";
    noteText.textContent = note.text;

    setTimeout(() => {
      popup.classList.remove("show");
      noteRef.remove();
    }, 4500);
  });
</script>

</body>
</html>
