import React, { useState, useEffect, useRef, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, 
  doc, 
  setDoc, 
  onSnapshot, 
  collection, 
  addDoc, 
  query, 
  orderBy, 
  serverTimestamp,
  updateDoc
} from 'firebase/firestore';
import { 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken, 
  onAuthStateChanged 
} from 'firebase/auth';
import { 
  Heart, 
  MessageCircle, 
  Cloud, 
  Settings, 
  Send, 
  Sparkles, 
  MapPin, 
  Clock,
  Mic,
  Smile,
  Zap,
  Volume2,
  Wand2,
  CalendarHeart,
  Smartphone,
  Loader2
} from 'lucide-react';

// --- CONFIG & CONSTANTS ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'sunahh-pro';
const apiKey = ""; // Managed by environment

const MOODS = [
  { id: 'love', icon: 'üíñ', color: 'from-pink-500 to-rose-600', bg: 'bg-rose-950/20', theme: '#4c0519' },
  { id: 'missing', icon: 'ü•∫', color: 'from-blue-400 to-indigo-600', bg: 'bg-indigo-950/20', theme: '#1e1b4b' },
  { id: 'joy', icon: '‚ú®', color: 'from-amber-300 to-orange-500', bg: 'bg-amber-950/20', theme: '#451a03' },
  { id: 'tired', icon: 'üò¥', color: 'from-purple-400 to-violet-700', bg: 'bg-violet-950/20', theme: '#2e1065' },
  { id: 'angry', icon: 'üí¢', color: 'from-red-500 to-orange-700', bg: 'bg-red-950/20', theme: '#450a0a' },
];

// --- UTILS ---
const fetchWithRetry = async (url, options, retries = 5, backoff = 1000) => {
  try {
    const response = await fetch(url, options);
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    return await response.json();
  } catch (error) {
    if (retries > 0) {
      await new Promise(resolve => setTimeout(resolve, backoff));
      return fetchWithRetry(url, options, retries - 1, backoff * 2);
    }
    throw error;
  }
};

const pcmToWav = (pcmData, sampleRate) => {
  const buffer = new ArrayBuffer(44 + pcmData.length * 2);
  const view = new DataView(buffer);
  const writeString = (offset, string) => {
    for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i));
  };
  writeString(0, 'RIFF');
  view.setUint32(4, 32 + pcmData.length * 2, true);
  writeString(8, 'WAVE');
  writeString(12, 'fmt ');
  view.setUint32(16, 16, true);
  view.setUint16(20, 1, true);
  view.setUint16(22, 1, true);
  view.setUint32(24, sampleRate, true);
  view.setUint32(28, sampleRate * 2, true);
  view.setUint16(32, 2, true);
  view.setUint16(34, 16, true);
  writeString(36, 'data');
  view.setUint32(40, pcmData.length * 2, true);
  for (let i = 0; i < pcmData.length; i++) view.setInt16(44 + i * 2, pcmData[i], true);
  return new Blob([buffer], { type: 'audio/wav' });
};

// --- COMPONENTS ---

const App = () => {
  const [loading, setLoading] = useState(true);
  const [user, setUser] = useState(null);
  const [partner, setPartner] = useState(null);
  const [messages, setMessages] = useState([]);
  const [dreams, setDreams] = useState([]);
  const [view, setView] = useState('home'); 
  const [isPressing, setIsPressing] = useState(false);
  const [inputMsg, setInputMsg] = useState('');
  const [dreamPrompt, setDreamPrompt] = useState('');
  const [isGeneratingDream, setIsGeneratingDream] = useState(false);
  const [isEnhancing, setIsEnhancing] = useState(false);
  const [myMood, setMyMood] = useState('love');
  const [pulseScale, setPulseScale] = useState(1);
  const [vibrationActive, setVibrationActive] = useState(false);
  const [isPlayingAudio, setIsPlayingAudio] = useState(null);
  const [showInstallTip, setShowInstallTip] = useState(false);

  const myId = useMemo(() => {
    const hash = window.location.hash.replace('#', '').toLowerCase();
    return hash === 'abhishek' ? 'abhishek' : 'sana';
  }, []);
  const partnerId = myId === 'abhishek' ? 'sana' : 'abhishek';

  // --- NATIVE APP EMULATION ---
  useEffect(() => {
    // Prevent browser gestures
    document.body.style.overscrollBehavior = 'none';
    document.documentElement.style.overscrollBehavior = 'none';

    const currentMoodTheme = MOODS.find(m => m.id === myMood)?.theme || '#0f172a';
    
    const metas = [
      { name: 'apple-mobile-web-app-capable', content: 'yes' },
      { name: 'apple-mobile-web-app-status-bar-style', content: 'black-translucent' },
      { name: 'apple-mobile-web-app-title', content: 'Sunahh' },
      { name: 'viewport', content: 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover' },
      { name: 'theme-color', content: currentMoodTheme }
    ];
    
    metas.forEach(m => {
      let meta = document.querySelector(`meta[name="${m.name}"]`);
      if (!meta) {
        meta = document.createElement('meta');
        meta.name = m.name;
        document.head.appendChild(meta);
      }
      meta.content = m.content;
    });

    // Mock Splash Screen timeout
    setTimeout(() => setLoading(false), 2500);

    const isStandalone = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;
    if (!isStandalone) setShowInstallTip(true);
  }, [myMood]);

  // --- FIREBASE SYNC ---
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  useEffect(() => {
    if (!user) return;
    const updatePresence = async () => {
      await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'presence', myId), {
        uid: user.uid,
        lastSeen: serverTimestamp(),
        isPressing,
        mood: myMood,
        id: myId
      }, { merge: true });
    };
    updatePresence();
    const interval = setInterval(updatePresence, 5000);
    return () => clearInterval(interval);
  }, [user, isPressing, myMood, myId]);

  useEffect(() => {
    if (!user) return;
    const unsubPartner = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'presence', partnerId), (doc) => setPartner(doc.data()));
    return () => unsubPartner();
  }, [user, partnerId]);

  useEffect(() => {
    if (!user) return;
    const qMsg = query(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), orderBy('timestamp', 'desc'));
    const unsubMsgs = onSnapshot(qMsg, (snap) => setMessages(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })).reverse()));
    
    const qDreams = query(collection(db, 'artifacts', appId, 'public', 'data', 'dreams'), orderBy('timestamp', 'desc'));
    const unsubDreams = onSnapshot(qDreams, (snap) => setDreams(snap.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
    
    return () => { unsubMsgs(); unsubDreams(); };
  }, [user]);

  // --- ACTIONS ---
  const handleEnhanceWhisper = async () => {
    if (!inputMsg.trim()) return;
    setIsEnhancing(true);
    try {
      const prompt = `Rewrite this simple message from a long distance lover to their partner. Make it poetic, deeply romantic, and intimate, but keep the original meaning: "${inputMsg}"`;
      const result = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
      });
      const enhanced = result.candidates?.[0]?.content?.parts?.[0]?.text?.replace(/["']/g, "").trim();
      if (enhanced) setInputMsg(enhanced);
    } catch (e) { console.error(e); } finally { setIsEnhancing(false); }
  };

  const handleListenToMessage = async (msgId, text) => {
    if (isPlayingAudio === msgId) return;
    setIsPlayingAudio(msgId);
    try {
      const payload = {
        contents: [{ parts: [{ text: `Say warmly and intimately: ${text}` }] }],
        generationConfig: {
          responseModalities: ["AUDIO"],
          speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Aoede" } } }
        },
        model: "gemini-2.5-flash-preview-tts"
      };
      const result = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const base64Audio = result.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
      if (base64Audio) {
        const binary = atob(base64Audio);
        const pcmData = new Int16Array(binary.length / 2);
        for (let i = 0; i < pcmData.length; i++) {
          pcmData[i] = binary.charCodeAt(i * 2) | (binary.charCodeAt(i * 2 + 1) << 8);
        }
        const wavBlob = pcmToWav(pcmData, 24000);
        const url = URL.createObjectURL(wavBlob);
        const audio = new Audio(url);
        audio.onended = () => setIsPlayingAudio(null);
        audio.play();
      }
    } catch (e) { setIsPlayingAudio(null); }
  };

  const handlePlanDream = async (dream) => {
    if (dream.plan) return;
    try {
      const prompt = `Based on this romantic dream/visual: "${dream.prompt}", create a 1-day detailed real-world itinerary for a couple meeting in person. Include specific activities, a romantic dinner idea, and a small "love task" for them to do. Keep it sweet and practical.`;
      const result = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
      });
      const plan = result.candidates?.[0]?.content?.parts?.[0]?.text;
      if (plan) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'dreams', dream.id), { plan });
    } catch (e) { console.error(e); }
  };

  const handleSendMessage = async () => {
    if (!inputMsg.trim()) return;
    const text = inputMsg;
    setInputMsg('');
    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), {
      text, sender: myId, timestamp: serverTimestamp()
    });
  };

  const handleGenerateDream = async () => {
    if (!dreamPrompt.trim()) return;
    setIsGeneratingDream(true);
    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`, {
        method: 'POST',
        body: JSON.stringify({
          instances: { prompt: `Cinematic romantic photography of: ${dreamPrompt}. Soft lighting, ethereal, hyper-realistic.` },
          parameters: { sampleCount: 1 }
        })
      });
      const data = await response.json();
      const imageUrl = `data:image/png;base64,${data.predictions[0].bytesBase64Encoded}`;
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'dreams'), {
        imageUrl, prompt: dreamPrompt, creator: myId, timestamp: serverTimestamp()
      });
      setDreamPrompt('');
    } catch (e) { console.error(e); } finally { setIsGeneratingDream(false); }
  };

  useEffect(() => {
    let interval;
    if (isPressing && partner?.isPressing) {
      if (!vibrationActive && navigator.vibrate) {
        navigator.vibrate([20, 40, 20]);
        setVibrationActive(true);
      }
      interval = setInterval(() => setPulseScale(s => s === 1.15 ? 0.95 : 1.15), 500);
    } else {
      setPulseScale(1);
      setVibrationActive(false);
    }
    return () => clearInterval(interval);
  }, [isPressing, partner?.isPressing]);

  const formatTime = (ts) => {
    if (!ts) return "...";
    const date = ts.toDate ? ts.toDate() : new Date(ts);
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  };

  const currentMoodData = MOODS.find(m => m.id === (partner?.mood || 'love'));

  // --- LOADING / SPLASH ---
  if (loading) {
    return (
      <div className="fixed inset-0 bg-slate-950 flex flex-col items-center justify-center gap-6 z-[100]">
        <div className="relative">
          <Heart size={80} className="text-rose-500 animate-pulse" fill="currentColor" />
          <div className="absolute inset-0 bg-rose-500 blur-2xl opacity-20 scale-150 animate-pulse" />
        </div>
        <div className="flex flex-col items-center gap-2">
          <h1 className="text-3xl font-bold tracking-widest text-white/90">SUNAHH</h1>
          <p className="text-[10px] text-white/30 uppercase tracking-[0.4em]">Our Private World</p>
        </div>
        <Loader2 className="animate-spin text-white/10 mt-12" size={24} />
      </div>
    );
  }

  return (
    <div className={`min-h-screen transition-all duration-1000 overflow-hidden flex flex-col font-sans ${currentMoodData?.bg || 'bg-slate-950'} text-white select-none`}>
      
      {/* Background Ambient Glow */}
      <div className="fixed inset-0 pointer-events-none opacity-30">
        <div className={`absolute top-[-10%] left-[-10%] w-[60%] h-[60%] blur-[140px] rounded-full bg-gradient-to-br ${currentMoodData?.color || 'from-blue-500 to-purple-500'}`} />
        <div className="absolute bottom-[-10%] right-[-10%] w-[60%] h-[60%] blur-[140px] rounded-full bg-gradient-to-tl from-pink-500 to-rose-500" />
      </div>

      {/* Header */}
      <header className="relative z-10 px-8 pt-[max(env(safe-area-inset-top),3.5rem)] flex justify-between items-center">
        <div>
          <h1 className="text-3xl font-bold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-white to-white/40">
            {myId === 'abhishek' ? 'Sana' : 'Abhishek'}
          </h1>
          <div className="flex items-center gap-2 mt-2">
            <div className={`w-2.5 h-2.5 rounded-full ${partner?.isPressing ? 'bg-green-400 animate-pulse' : 'bg-white/20'}`} />
            <span className="text-[10px] text-white/40 uppercase tracking-[0.2em]">
              {partner?.isPressing ? 'Touching you now' : (partner?.lastSeen ? `Seen ${formatTime(partner.lastSeen)}` : 'Offline')}
            </span>
          </div>
        </div>
        <button onClick={() => setView('settings')} className={`p-3 rounded-2xl transition-all ${view === 'settings' ? 'bg-white/20' : 'bg-white/5 backdrop-blur-md border border-white/10'}`}>
          <Smile size={22} />
        </button>
      </header>

      {/* Main Content Area */}
      <main className="flex-1 relative z-10 overflow-y-auto pb-40">
        {view === 'home' && (
          <div className="h-full flex flex-col items-center justify-center p-6 gap-16">
            
            {showInstallTip && (
              <div className="bg-white/10 backdrop-blur-md border border-white/10 p-4 rounded-2xl flex items-center gap-4 max-w-xs">
                <Smartphone className="text-amber-300 shrink-0" size={24} />
                <p className="text-[11px] text-white/70 leading-tight">
                  For the full app experience, <strong className="text-white">Add to Home Screen</strong> from your browser menu.
                </p>
                <button onClick={() => setShowInstallTip(false)} className="text-white/40 ml-auto">‚úï</button>
              </div>
            )}

            <div className="relative">
              {isPressing && <div className="absolute inset-0 animate-ping rounded-full bg-white/10 scale-150 pointer-events-none" />}
              {partner?.isPressing && <div className="absolute inset-0 animate-pulse rounded-full border border-white/30 scale-125 pointer-events-none" />}
              
              <button
                onMouseDown={() => setIsPressing(true)}
                onMouseUp={() => setIsPressing(false)}
                onTouchStart={() => setIsPressing(true)}
                onTouchEnd={() => setIsPressing(false)}
                style={{ transform: `scale(${pulseScale})` }}
                className={`relative w-72 h-72 rounded-full flex items-center justify-center transition-all duration-300
                  ${isPressing && partner?.isPressing ? 'shadow-[0_0_100px_rgba(255,255,255,0.3)] bg-white/20' : 'bg-white/5 shadow-2xl'}
                  backdrop-blur-xl border border-white/20
                `}
              >
                {isPressing && partner?.isPressing ? <Zap size={100} className="text-amber-300 animate-pulse" /> : 
                  <Heart size={100} fill={(isPressing || partner?.isPressing) ? 'currentColor' : 'none'} className={`transition-all duration-500 ${isPressing || partner?.isPressing ? 'text-rose-400 scale-110' : 'text-white/10'}`} />
                }
                <div className="absolute -top-6 -right-4 text-5xl animate-bounce drop-shadow-lg">
                  {partner?.mood ? MOODS.find(m => m.id === partner.mood)?.icon : '‚ù§Ô∏è'}
                </div>
              </button>
            </div>

            <div className="grid grid-cols-2 gap-4 w-full max-w-sm">
              <div className="bg-white/5 backdrop-blur-md p-5 rounded-[2rem] border border-white/10 flex items-center gap-4">
                <Clock className="text-blue-400" size={20} />
                <div>
                  <div className="text-[9px] text-white/40 uppercase font-bold tracking-widest">Local Time</div>
                  <div className="text-base font-semibold">{new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
                </div>
              </div>
              <div className="bg-white/5 backdrop-blur-md p-5 rounded-[2rem] border border-white/10 flex items-center gap-4">
                <MapPin className="text-rose-400" size={20} />
                <div>
                  <div className="text-[9px] text-white/40 uppercase font-bold tracking-widest">Connected</div>
                  <div className="text-base font-semibold">Always</div>
                </div>
              </div>
            </div>
          </div>
        )}

        {view === 'chat' && (
          <div className="h-full flex flex-col px-6 pt-6">
            <div className="flex-1 space-y-6 pb-6">
              {messages.map((m) => (
                <div key={m.id} className={`flex flex-col ${m.sender === myId ? 'items-end' : 'items-start'}`}>
                  <div className={`group relative max-w-[85%] px-5 py-4 rounded-3xl text-[15px] leading-relaxed transition-all ${
                    m.sender === myId ? 'bg-white text-black rounded-tr-none shadow-lg' : 'bg-white/10 backdrop-blur-md rounded-tl-none border border-white/10'
                  }`}>
                    {m.text}
                    {m.sender !== myId && (
                      <button 
                        onClick={() => handleListenToMessage(m.id, m.text)}
                        className={`absolute -right-10 top-1/2 -translate-y-1/2 p-2 rounded-full bg-white/5 border border-white/10 hover:bg-white/20 transition-all ${isPlayingAudio === m.id ? 'text-amber-400 animate-pulse' : 'text-white/40'}`}>
                        <Volume2 size={16} />
                      </button>
                    )}
                  </div>
                  <div className="text-[10px] mt-2 text-white/20 uppercase font-bold px-1">{formatTime(m.timestamp)}</div>
                </div>
              ))}
            </div>
            
            <div className="sticky bottom-[max(1rem,env(safe-area-inset-bottom))] pt-2">
              <div className="flex flex-col gap-3 bg-white/10 backdrop-blur-2xl p-3 rounded-[2.5rem] border border-white/20 shadow-2xl">
                <div className="flex items-center gap-2">
                  <input 
                    value={inputMsg}
                    onChange={(e) => setInputMsg(e.target.value)}
                    onKeyDown={(e) => e.key === 'Enter' && handleSendMessage()}
                    placeholder="Whisper your heart..." 
                    className="flex-1 bg-transparent border-none outline-none px-4 py-2 text-sm placeholder:text-white/30"
                  />
                  <button onClick={handleEnhanceWhisper} className="p-3 text-amber-300 transition-all hover:scale-110 active:scale-95">
                    <Wand2 size={20} />
                  </button>
                  <button onClick={handleSendMessage} className="bg-white text-black p-3 rounded-full shadow-lg hover:bg-white/90 active:scale-90">
                    <Send size={20} />
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {view === 'dreams' && (
          <div className="p-8 space-y-10">
            <div className="bg-white/5 backdrop-blur-xl p-8 rounded-[3rem] border border-white/10 shadow-2xl space-y-6">
              <div className="flex items-center gap-4">
                <Sparkles size={24} className="text-amber-300" />
                <h2 className="text-xl font-bold">Dream Together</h2>
              </div>
              <textarea 
                value={dreamPrompt}
                onChange={(e) => setDreamPrompt(e.target.value)}
                placeholder="Us sitting on a rooftop in Paris..."
                className="w-full bg-white/5 rounded-2xl p-5 text-[15px] border border-white/10 min-h-[120px] outline-none"
              />
              <button onClick={handleGenerateDream} disabled={isGeneratingDream} className="w-full bg-white text-black font-bold py-4 rounded-2xl transition-all disabled:opacity-50">
                {isGeneratingDream ? 'Painting...' : 'Generate Moment'}
              </button>
            </div>
            
            <div className="space-y-8">
              {dreams.map((dream) => (
                <div key={dream.id} className="bg-white/5 backdrop-blur-md rounded-[2.5rem] overflow-hidden border border-white/10 group shadow-2xl">
                  <img src={dream.imageUrl} alt="Dream" className="w-full aspect-[4/5] object-cover" />
                  <div className="p-6 space-y-4">
                    <p className="text-sm italic text-white/70 leading-relaxed font-serif">"{dream.prompt}"</p>
                    {dream.plan ? (
                      <div className="bg-white/5 p-5 rounded-2xl text-[11px] leading-relaxed text-white/50 border border-white/5 whitespace-pre-wrap">
                        <div className="flex items-center gap-2 mb-2 text-amber-200 font-bold uppercase tracking-widest text-[9px]">
                          <CalendarHeart size={14} /> Our Date Plan
                        </div>
                        {dream.plan}
                      </div>
                    ) : (
                      <button onClick={() => handlePlanDream(dream)} className="flex items-center gap-2 text-[10px] font-bold uppercase tracking-widest bg-white/10 px-4 py-2 rounded-full text-amber-200">
                        <CalendarHeart size={14} /> ‚ú® Plan This Date
                      </button>
                    )}
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        {view === 'settings' && (
          <div className="p-8 space-y-12">
            <section>
              <h3 className="text-[10px] font-bold text-white/30 uppercase tracking-[0.3em] mb-6 px-2">Heart Status</h3>
              <div className="grid grid-cols-2 gap-4">
                {MOODS.map(m => (
                  <button
                    key={m.id}
                    onClick={() => setMyMood(m.id)}
                    className={`flex items-center gap-4 p-5 rounded-[2rem] border transition-all active:scale-95 ${
                      myMood === m.id ? 'bg-white text-black border-white shadow-xl' : 'bg-white/5 border-white/10 text-white'
                    }`}
                  >
                    <span className="text-3xl">{m.icon}</span>
                    <span className="text-sm font-bold capitalize">{m.id}</span>
                  </button>
                ))}
              </div>
            </section>
            
            <section className="bg-rose-500/10 backdrop-blur-md p-8 rounded-[3rem] border border-rose-500/20 space-y-4 shadow-xl">
              <div className="flex items-center gap-3 text-rose-400">
                <Zap size={20} />
                <h3 className="font-bold uppercase tracking-widest text-xs">Private Portal</h3>
              </div>
              <p className="text-xs text-rose-300/60 leading-relaxed">Identity: <strong>{myId}</strong>.</p>
              <button 
                onClick={() => window.location.hash = myId === 'abhishek' ? 'sana' : 'abhishek'}
                className="w-full text-xs font-bold uppercase tracking-widest bg-rose-500/20 py-4 rounded-2xl text-rose-200">
                Switch Role
              </button>
            </section>
          </div>
        )}
      </main>

      {/* Navigation */}
      <nav className="fixed bottom-[max(2.5rem,env(safe-area-inset-bottom))] left-1/2 -translate-x-1/2 bg-white/10 backdrop-blur-3xl border border-white/20 p-2.5 rounded-full flex items-center gap-2 z-50 shadow-2xl">
        <button onClick={() => setView('home')} className={`p-5 rounded-full transition-all active:scale-90 ${view === 'home' ? 'bg-white text-black shadow-lg scale-110' : 'text-white hover:bg-white/10'}`}>
          <Heart size={22} fill={view === 'home' ? 'currentColor' : 'none'} />
        </button>
        <button onClick={() => setView('chat')} className={`relative p-5 rounded-full transition-all active:scale-90 ${view === 'chat' ? 'bg-white text-black shadow-lg scale-110' : 'text-white hover:bg-white/10'}`}>
          <MessageCircle size={22} />
          {messages.length > 0 && messages[messages.length-1].sender !== myId && (
            <div className="absolute top-4 right-4 w-3 h-3 bg-rose-500 rounded-full border-[3px] border-slate-900" />
          )}
        </button>
        <button onClick={() => setView('dreams')} className={`p-5 rounded-full transition-all active:scale-90 ${view === 'dreams' ? 'bg-white text-black shadow-lg scale-110' : 'text-white hover:bg-white/10'}`}>
          <Cloud size={22} />
        </button>
      </nav>

    </div>
  );
};

export default App;