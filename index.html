<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Touch Sync</title>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
  body {
    margin: 0;
    height: 100vh;
    background: #0f0f0f;
    font-family: Arial, sans-serif;
    color: white;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  /* TOUCH AREA */
  #thumb {
    width: 240px;
    height: 240px;
    border-radius: 50%;
    background: #333;
    transition: background 0.3s ease, transform 0.2s ease;
    touch-action: none;
    pointer-events: auto;
  }

  @keyframes heartbeat {
    0% { transform: scale(1); }
    25% { transform: scale(1.06); }
    45% { transform: scale(1); }
    65% { transform: scale(1.08); }
    100% { transform: scale(1); }
  }

  #thumb.sync {
    animation: heartbeat 1.2s infinite;
  }

  #status {
    margin-top: 16px;
    font-size: 13px;
    opacity: 0.75;
    min-height: 18px;
  }

  /* MINI CHAT */
  #chat {
    margin-top: 10px;
    width: 220px;
    height: 60px;
    overflow-y: auto;
    font-size: 12px;
    opacity: 0.6;
    pointer-events: none; /* IMPORTANT */
  }

  .msg {
    margin-bottom: 4px;
  }

  .me { text-align: right; }
  .other { text-align: left; }

  #inputBox {
    margin-top: 6px;
    display: flex;
    gap: 6px;
    width: 220px;
  }

  #inputBox input {
    flex: 1;
    padding: 6px 10px;
    border-radius: 12px;
    border: none;
    font-size: 12px;
    outline: none;
  }

  #inputBox button {
    padding: 6px 10px;
    border-radius: 12px;
    border: none;
    font-size: 12px;
    cursor: pointer;
  }
</style>
</head>

<body>

<div id="thumb"></div>
<div id="status"></div>

<div id="chat"></div>

<div id="inputBox">
  <input id="text" placeholder="say somethingâ€¦" />
  <button onclick="send()">â†’</button>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBxm9XNECnnua2ygeOSfQUQAoon8VBabgQ",
    authDomain: "sunahh-43bb8.firebaseapp.com",
    databaseURL: "https://sunahh-43bb8-default-rtdb.firebaseio.com",
    projectId: "sunahh-43bb8",
    storageBucket: "sunahh-43bb8.appspot.com",
    messagingSenderId: "1018778991584",
    appId: "1:1018778991584:web:34d11d94c1175a5f1d4985"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const sessionId = "test-session";
  const uid = Math.random().toString(36).slice(2);
  const myColor = `hsl(${Math.floor(Math.random()*360)},70%,60%)`;

  const userRef = db.ref(`sessions/${sessionId}/users/${uid}`);
  const chatRef = db.ref(`sessions/${sessionId}/chat`);

  const thumb = document.getElementById("thumb");
  const status = document.getElementById("status");
  const chat = document.getElementById("chat");
  const input = document.getElementById("text");

  /* PRESENCE HEARTBEAT */
  setInterval(() => {
    userRef.update({ lastSeen: Date.now(), color: myColor });
  }, 5000);

  /* TOUCH */
  function setPressed(v) {
    userRef.update({ pressed: v, lastSeen: Date.now() });
  }

  ["mousedown","touchstart"].forEach(e =>
    thumb.addEventListener(e, () => setPressed(true))
  );
  ["mouseup","mouseleave","touchend","touchcancel"].forEach(e =>
    thumb.addEventListener(e, () => setPressed(false))
  );

  /* CHAT */
  function send() {
    const t = input.value.trim();
    if (!t) return;
    chatRef.push({ from: uid, text: t, time: Date.now() });
    input.value = "";
  }

  chatRef.limitToLast(3).on("child_added", s => {
    const m = s.val();
    const d = document.createElement("div");
    d.className = "msg " + (m.from === uid ? "me" : "other");
    d.textContent = m.text;
    chat.appendChild(d);
    chat.scrollTop = chat.scrollHeight;
  });

  /* STATE LOGIC */
  db.ref(`sessions/${sessionId}`).on("value", snap => {
    const data = snap.val();
    if (!data || !data.users) return;

    const me = data.users[uid];
    let other = null;
    Object.keys(data.users).forEach(id => {
      if (id !== uid) other = data.users[id];
    });

    const now = Date.now();
    const otherOnline = other && now - other.lastSeen < 15000;

    const iPress = me?.pressed;
    const oPress = other?.pressed;

    if (!iPress && !oPress) {
      thumb.style.background = "#333";
      thumb.classList.remove("sync");
      status.textContent = otherOnline ? "â€¢ online" :
        other?.lastSeen ? "last seen recently" : "";
    }

    if (!iPress && oPress) {
      thumb.style.background = other.color;
      thumb.classList.remove("sync");
      status.textContent = "someone is holding you";
    }

    if (iPress && !oPress) {
      thumb.style.background = me.color;
      thumb.classList.remove("sync");
      status.textContent = "pressing";
    }

    if (iPress && oPress) {
      thumb.style.background =
        `linear-gradient(135deg, ${me.color}, ${other.color})`;
      thumb.classList.add("sync");
      status.textContent = "ðŸ’ž youâ€™re connected right now";
    }
  });
</script>

</body>
</html>
