<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Touch</title>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
  body {
    margin: 0;
    height: 100vh;
    background: #0f0f0f;
    font-family: system-ui, sans-serif;
    color: white;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  /* TOUCH */
  #thumb {
    width: 240px;
    height: 240px;
    border-radius: 50%;
    background: #333;
    transition: background 0.35s ease, transform 0.2s ease;
    touch-action: none;
  }

  @keyframes heartbeat {
    0% { transform: scale(1); }
    25% { transform: scale(1.06); }
    45% { transform: scale(1); }
    65% { transform: scale(1.08); }
    100% { transform: scale(1); }
  }

  #thumb.sync { animation: heartbeat 1.2s infinite; }

  #status {
    margin-top: 14px;
    font-size: 13px;
    opacity: 0.75;
    min-height: 18px;
    text-align: center;
  }

  /* NOTE INPUT */
  #noteBox {
    margin-top: 18px;
    display: flex;
    gap: 6px;
    align-items: center;
  }

  #noteBox input,
  #noteBox select {
    padding: 7px 10px;
    border-radius: 14px;
    border: none;
    font-size: 12px;
    background: #1a1a1a;
    color: white;
    outline: none;
  }

  #noteBox button {
    padding: 7px 10px;
    border-radius: 14px;
    border: none;
    font-size: 12px;
    cursor: pointer;
    background: #2a2a2a;
    color: white;
  }

  /* POPUP */
  #notePopup {
    position: fixed;
    bottom: 120px;
    max-width: 260px;
    padding: 16px;
    border-radius: 18px;
    text-align: center;
    font-size: 14px;
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 0.4s ease, transform 0.4s ease;
    pointer-events: none;
  }

  #notePopup.show {
    opacity: 1;
    transform: translateY(0);
  }

  /* MOODS */
  .love {
    background: #ff7aa2;
    box-shadow: 0 0 30px #ff7aa255;
  }

  .joy {
    background: #ffd86b;
    color: #2b2b2b;
    animation: glow 1.5s infinite;
  }

  .angry {
    background: #ff4b3a;
    animation: shake 0.4s infinite;
  }

  @keyframes glow {
    0% { box-shadow: 0 0 10px #ffd86b66; }
    50% { box-shadow: 0 0 25px #ffd86bcc; }
    100% { box-shadow: 0 0 10px #ffd86b66; }
  }

  @keyframes shake {
    0% { transform: translateX(0); }
    25% { transform: translateX(-3px); }
    50% { transform: translateX(3px); }
    75% { transform: translateX(-3px); }
    100% { transform: translateX(0); }
  }

  #seen {
    margin-top: 6px;
    font-size: 11px;
    opacity: 0.6;
  }
</style>
</head>

<body>

<div id="thumb"></div>
<div id="status"></div>

<div id="noteBox">
  <input id="noteInput" placeholder="leave a note‚Ä¶" />
  <select id="mood">
    <option value="love">‚ù§Ô∏è love</option>
    <option value="joy">üòÑ joy</option>
    <option value="angry">üò° angry</option>
  </select>
  <button onclick="sendNote()">‚Üí</button>
</div>

<div id="notePopup">
  <div id="noteText"></div>
</div>

<div id="seen"></div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBxm9XNECnnua2ygeOSfQUQAoon8VBabgQ",
    authDomain: "sunahh-43bb8.firebaseapp.com",
    databaseURL: "https://sunahh-43bb8-default-rtdb.firebaseio.com",
    projectId: "sunahh-43bb8",
    storageBucket: "sunahh-43bb8.appspot.com",
    messagingSenderId: "1018778991584",
    appId: "1:1018778991584:web:34d11d94c1175a5f1d4985"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const sessionId = "touch-session";
  const uid = Math.random().toString(36).slice(2);
  const myColor = `hsl(${Math.floor(Math.random()*360)},70%,60%)`;

  const userRef = db.ref(`sessions/${sessionId}/users/${uid}`);
  const sessionRef = db.ref(`sessions/${sessionId}`);
  const noteRef = sessionRef.child("note");

  const thumb = document.getElementById("thumb");
  const status = document.getElementById("status");
  const popup = document.getElementById("notePopup");
  const noteText = document.getElementById("noteText");
  const seen = document.getElementById("seen");

  /* Presence */
  setInterval(() => {
    userRef.update({ lastSeen: Date.now(), color: myColor });
  }, 5000);

  /* Touch */
  function setPressed(v) {
    userRef.update({ pressed: v, lastSeen: Date.now() });
  }

  ["mousedown","touchstart"].forEach(e =>
    thumb.addEventListener(e, () => setPressed(true))
  );
  ["mouseup","mouseleave","touchend","touchcancel"].forEach(e =>
    thumb.addEventListener(e, () => setPressed(false))
  );

  /* Touch state */
  sessionRef.on("value", snap => {
    const data = snap.val();
    if (!data || !data.users) return;

    let iPress = false, otherPress = false, otherColor = null, otherOnline = false;

    Object.entries(data.users).forEach(([id,u]) => {
      if (id === uid) iPress = !!u.pressed;
      else {
        if (u.pressed) { otherPress = true; otherColor = u.color; }
        if (u.lastSeen && Date.now() - u.lastSeen < 15000) otherOnline = true;
      }
    });

    if (!iPress && !otherPress) {
      thumb.style.background = "#333";
      thumb.classList.remove("sync");
      status.textContent = otherOnline ? "‚Ä¢ online" : "last seen recently";
    }

    if (!iPress && otherPress) {
      thumb.style.background = otherColor;
      thumb.classList.remove("sync");
      status.textContent = "someone is holding you";
    }

    if (iPress && !otherPress) {
      thumb.style.background = myColor;
      thumb.classList.remove("sync");
      status.textContent = "pressing";
    }

    if (iPress && otherPress) {
      thumb.style.background = `linear-gradient(135deg, ${myColor}, ${otherColor})`;
      thumb.classList.add("sync");
      status.textContent = "üíû you‚Äôre connected right now";
    }
  });

  /* Send note */
  function sendNote() {
    const text = noteInput.value.trim();
    const mood = document.getElementById("mood").value;
    if (!text) return;

    noteRef.set({
      text,
      mood,
      from: uid,
      id: Date.now(),
      read: false
    });

    noteInput.value = "";
    seen.textContent = "";
  }

  /* Show note ONLY on open */
  const openedAt = Date.now();

  noteRef.once("value").then(snap => {
    const note = snap.val();
    if (!note) return;
    if (note.from === uid) return;
    if (note.read) return;
    if (note.id < openedAt - 1000) return;

    popup.className = note.mood + " show";
    noteText.textContent = note.text;
    noteRef.update({ read: true });

    setTimeout(() => popup.classList.remove("show"), 4500);
  });

  /* Seen indicator */
  noteRef.on("value", snap => {
    const note = snap.val();
    if (note && note.from === uid && note.read) {
      seen.textContent = "seen";
    }
  });
</script>

</body>
</html>
