<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Touch</title>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
:root{
  --bg1:#120f14;
  --bg2:#1b1622;
  --accent:rgba(255,255,255,.12);
}

/* MOODS */
body[data-mood="love"]{--bg1:#2a1420;--bg2:#120f14;--accent:rgba(255,160,190,.35);}
body[data-mood="joy"]{--bg1:#2a220f;--bg2:#18140c;--accent:rgba(255,210,140,.4);}
body[data-mood="angry"]{--bg1:#2a1010;--bg2:#160c0c;--accent:rgba(255,120,120,.35);}
body[data-mood="missing"]{--bg1:#0b1016;--bg2:#111824;--accent:rgba(140,170,220,.35);}

*{user-select:none;-webkit-tap-highlight-color:transparent}

body{
  margin:0;
  min-height:100vh;
  background:
    radial-gradient(60% 50% at 50% 15%,var(--accent),transparent 60%),
    linear-gradient(180deg,var(--bg2),var(--bg1));
  font-family:system-ui,-apple-system;
  color:white;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  transition:background 1.2s ease;
}

/* CIRCLE */
#thumb{
  width:260px;
  height:260px;
  border-radius:50%;
  background:radial-gradient(circle at top left,
    rgba(255,255,255,.18),
    rgba(255,255,255,.03));
  box-shadow:
    inset 0 0 0 1px rgba(255,255,255,.1),
    0 0 40px var(--accent),
    0 20px 60px rgba(0,0,0,.45);
  transition:background .4s ease, transform .25s ease;
}

/* smoother + faster heartbeat */
#thumb.heartbeat{
  animation:heartbeat 0.9s ease-in-out infinite;
}
@keyframes heartbeat{
  0%{transform:scale(1)}
  18%{transform:scale(1.06)}
  36%{transform:scale(1)}
  55%{transform:scale(1.04)}
  100%{transform:scale(1)}
}

/* diffusing particles feel */
#thumb.diffuse{
  animation:diffuse 4.2s ease-in-out infinite;
}
@keyframes diffuse{
  0%{background-position:20% 30%, 80% 70%, center}
  50%{background-position:80% 60%, 20% 40%, center}
  100%{background-position:20% 30%, 80% 70%, center}
}

#status{margin-top:18px;font-size:13px;opacity:.75}
#lastSeen{margin-top:6px;font-size:12px;opacity:.5}

/* POPUP */
#notePopup{
  position:fixed;
  bottom:110px;
  left:50%;
  transform:translateX(-50%) translateY(14px);
  padding:18px 22px;
  border-radius:26px;
  background:rgba(255,255,255,.15);
  backdrop-filter:blur(14px);
  max-width:80%;
  text-align:center;
  font-size:15px;
  opacity:0;
  transition:.45s ease;
}
#notePopup.show{
  opacity:1;
  transform:translateX(-50%) translateY(0);
}

/* HISTORY */
#historyBtn{margin-top:14px;font-size:12px;opacity:.45;cursor:pointer;}
#historyPanel{
  position:fixed;inset:0;
  background:rgba(0,0,0,.55);
  backdrop-filter:blur(6px);
  display:none;align-items:flex-end;
}
#historyPanel.show{display:flex;}
#historyInner{
  width:100%;max-height:55%;
  background:rgba(20,20,30,.95);
  border-radius:22px 22px 0 0;
  padding:20px;overflow-y:auto;
}
.msg{margin-bottom:14px;}
.msg.you{opacity:.55;}
.msg span{font-size:11px;opacity:.4;display:block;margin-top:4px;}

/* INPUT */
#noteBox{
  width:100%;max-width:420px;
  margin-top:24px;
  display:flex;gap:10px;
}
#noteInput{
  flex:1;padding:14px 18px;
  border-radius:22px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.05);
  color:white;outline:none;
}
#noteBox button{
  padding:12px 16px;
  border-radius:20px;border:none;
  background:rgba(255,255,255,.12);
  color:white;
}
</style>
</head>

<body>

<div id="thumb"></div>
<div id="status"></div>
<div id="lastSeen"></div>

<div id="historyBtn">last messages</div>

<div id="noteBox">
  <input id="noteInput" placeholder="leave a thought…">
  <button id="sendBtn">→</button>
</div>

<div id="notePopup"></div>

<div id="historyPanel">
  <div id="historyInner"></div>
</div>

<script>
/* ---------- PRIVATE CODE ---------- */
const SECRET="sunahh";
if(localStorage._sunahh!==SECRET){
  const s=prompt("enter private code");
  if(s!==SECRET){document.body.innerHTML="private space";throw"";}
  localStorage._sunahh=SECRET;
}

/* ---------- ID ---------- */
const uid=location.hash.replace("#","").split("?")[0].toLowerCase();
if(!["abhishek","sana"].includes(uid)){
  document.body.innerHTML="private space";throw"";
}

/* ---------- PASTEL COLOR (ONCE PER SESSION) ---------- */
function pastelColor(){
  const h=Math.floor(Math.random()*360);
  const s=45+Math.random()*15;   // softer saturation
  const l=70+Math.random()*8;    // pastel lightness
  return `hsl(${h},${s}%,${l}%)`;
}
const myColor=pastelColor();

/* ---------- FIREBASE ---------- */
firebase.initializeApp({
  apiKey:"AIzaSyBxm9XNECnnua2ygeOSfQUQAoon8VBabgQ",
  databaseURL:"https://sunahh-43bb8-default-rtdb.firebaseio.com"
});
const db=firebase.database();
const session="abhishek-sana";
const userRef=db.ref(`sessions/${session}/users/${uid}`);
const sessionRef=db.ref(`sessions/${session}`);
const msgRef=db.ref(`sessions/${session}/messages`);

/* ---------- LAST SEEN ---------- */
setInterval(()=>userRef.update({lastSeen:Date.now(),color:myColor}),5000);
function timeAgo(ms){
  const d=Date.now()-ms;
  if(d<60000) return "just now";
  const m=Math.floor(d/60000);
  if(m<60) return m+" min ago";
  return Math.floor(m/60)+" hr ago";
}

/* ---------- VISUAL HELPERS ---------- */
const thumb=document.getElementById("thumb");

function showSolo(color){
  thumb.className="";
  thumb.style.background=`
    radial-gradient(circle at 35% 35%, rgba(255,255,255,.45), transparent 55%),
    radial-gradient(circle at center, ${color}, rgba(255,255,255,.25)),
    radial-gradient(circle at 65% 65%, rgba(255,255,255,.2), transparent 60%)
  `;
}

function showBlend(a,b){
  thumb.className="heartbeat diffuse";
  thumb.style.background=`
    radial-gradient(circle at 30% 30%, ${a}, transparent 55%),
    radial-gradient(circle at 70% 70%, ${b}, transparent 55%),
    radial-gradient(circle at center, rgba(255,255,255,.35), transparent 60%)
  `;
  thumb.style.backgroundSize="160% 160%, 160% 160%, cover";
}

/* ---------- PRESS ---------- */
let pressing=false;

thumb.onmousedown=thumb.ontouchstart=e=>{
  e.preventDefault();
  pressing=true;
  showSolo(myColor);
  userRef.update({pressed:true});
};

["mouseup","mouseleave","touchend"].forEach(ev=>{
  thumb.addEventListener(ev,()=>{
    if(!pressing) return;
    pressing=false;
    thumb.className="";
    thumb.style.background="";
    userRef.update({pressed:false});
  });
});

/* ---------- SYNC + HAPTIC ---------- */
let lastBeat=0;

sessionRef.on("value",snap=>{
  const u=snap.val()?.users||{};
  const me=u[uid];
  const other=u[uid==="abhishek"?"sana":"abhishek"];

  if(me?.pressed && other?.pressed){
    showBlend(me.color, other.color);

    const now=Date.now();
    if(navigator.vibrate && now-lastBeat>900){
      navigator.vibrate([20,40,20]);
      lastBeat=now;
    }
  }
  else if(other?.pressed){
    showSolo(other.color);
  }
  else if(me?.pressed){
    showSolo(me.color);
  }
  else{
    thumb.className="";
    thumb.style.background="";
  }

  if(other?.mood) document.body.dataset.mood=other.mood;
  lastSeen.textContent=other?.lastSeen
    ?"last seen · "+timeAgo(other.lastSeen)
    :"";
});

/* ---------- CHAT ---------- */
let lastPopupTime=0;

function sendNote(){
  const t=noteInput.value.trim();
  if(!t) return;
  msgRef.once("value",snap=>{
    let arr=snap.val()||[];
    arr.push({text:t,from:uid,time:Date.now()});
    if(arr.length>5) arr=arr.slice(-5);
    msgRef.set(arr);
    noteInput.value="";
  });
}
sendBtn.onclick=sendNote;
noteInput.onkeydown=e=>{if(e.key==="Enter") sendNote();};

msgRef.on("value",snap=>{
  const arr=snap.val(); if(!arr) return;

  historyInner.innerHTML="";
  arr.forEach(m=>{
    const d=document.createElement("div");
    d.className="msg "+(m.from===uid?"you":"them");
    d.innerHTML=`${m.text}<span>${timeAgo(m.time)}</span>`;
    historyInner.appendChild(d);
  });

  const last=arr[arr.length-1];
  if(last.from!==uid && last.time!==lastPopupTime){
    lastPopupTime=last.time;
    notePopup.textContent=last.text;
    notePopup.classList.add("show");
    setTimeout(()=>notePopup.classList.remove("show"),4000);
  }
});

/* ---------- HISTORY ---------- */
historyBtn.onclick=()=>historyPanel.classList.add("show");
historyPanel.onclick=e=>{
  if(e.target===historyPanel) historyPanel.classList.remove("show");
};
</script>

</body>
</html>
