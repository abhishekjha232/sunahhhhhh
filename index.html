<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Touch Sync</title>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <style>
    body {
      margin: 0;
      height: 100vh;
      background: #0f0f0f;
      font-family: Arial, sans-serif;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    #thumb {
      width: 220px;
      height: 220px;
      border-radius: 50%;
      background: #333;
      margin-bottom: 16px;
      transition: background 0.3s ease;
    }

    #status {
      font-size: 13px;
      opacity: 0.75;
      margin-bottom: 10px;
      min-height: 18px;
    }

    #chat {
      width: 90%;
      max-width: 360px;
      height: 180px;
      overflow-y: auto;
      background: #141414;
      border-radius: 14px;
      padding: 10px;
      font-size: 13px;
    }

    .msg {
      margin-bottom: 6px;
      opacity: 0.9;
    }

    .me { text-align: right; }
    .other { text-align: left; }

    #inputBox {
      display: flex;
      gap: 6px;
      margin-top: 10px;
      width: 90%;
      max-width: 360px;
    }

    #inputBox input {
      flex: 1;
      padding: 8px 12px;
      border-radius: 14px;
      border: none;
      outline: none;
    }

    #inputBox button {
      padding: 8px 14px;
      border-radius: 14px;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <div id="thumb"></div>
  <div id="status"></div>

  <div id="chat"></div>

  <div id="inputBox">
    <input id="text" placeholder="Type…" />
    <button onclick="send()">Send</button>
  </div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBxm9XNECnnua2ygeOSfQUQAoon8VBabgQ",
    authDomain: "sunahh-43bb8.firebaseapp.com",
    databaseURL: "https://sunahh-43bb8-default-rtdb.firebaseio.com",
    projectId: "sunahh-43bb8",
    storageBucket: "sunahh-43bb8.appspot.com",
    messagingSenderId: "1018778991584",
    appId: "1:1018778991584:web:34d11d94c1175a5f1d4985"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const sessionId = "test-session";
  const uid = Math.random().toString(36).slice(2);

  const userRef = db.ref(`sessions/${sessionId}/users/${uid}`);
  const chatRef = db.ref(`sessions/${sessionId}/chat`);
  const noteRef = db.ref(`sessions/${sessionId}/note`);

  const chatBox = document.getElementById("chat");
  const status = document.getElementById("status");
  const input = document.getElementById("text");

  // Presence heartbeat
  setInterval(() => {
    userRef.update({ lastSeen: Date.now() });
  }, 5000);

  function send() {
    const text = input.value.trim();
    if (!text) return;

    const msg = {
      from: uid,
      text,
      time: Date.now()
    };

    chatRef.push(msg);
    noteRef.set(msg); // also store as note if offline
    input.value = "";
  }

  chatRef.limitToLast(50).on("child_added", snap => {
    const m = snap.val();
    const div = document.createElement("div");
    div.className = "msg " + (m.from === uid ? "me" : "other");
    div.textContent = m.text;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
  });

  db.ref(`sessions/${sessionId}`).on("value", snap => {
    const data = snap.val();
    if (!data || !data.users) return;

    const users = Object.values(data.users);
    const other = users.find(u => u.lastSeen && u.lastSeen !== data.users[uid]?.lastSeen);

    if (!other) {
      status.textContent = "";
      return;
    }

    const online = Date.now() - other.lastSeen < 15000;
    status.textContent = online ? "• online" : "last seen recently";

    // Show note once when coming online
    if (data.note && data.note.from !== uid) {
      if (!localStorage.getItem("seenNote")) {
        const div = document.createElement("div");
        div.className = "msg other";
        div.textContent = data.note.text;
        chatBox.appendChild(div);
        localStorage.setItem("seenNote", "yes");
      }
    }
  });
</script>

</body>
</html>
