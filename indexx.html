<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Sunahh</title>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#f4f6fb;
  --card:#ffffff;
  --primary:#6c8cff;
  --secondary:#ff9fcf;
  --text:#1e2433;
  --muted:#7a8092;
  --border:#e5e8f2;
}
body{
  height:100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background:linear-gradient(180deg,#f6f8ff,#eef2ff);
  display:flex;justify-content:center;align-items:center;
  color:var(--text)
}
#app{
  width:100%;max-width:420px;height:100vh;
  background:var(--card);display:flex;flex-direction:column
}
@media(min-width:900px){
  #app{max-width:1100px;height:88vh;border-radius:26px;overflow:hidden;box-shadow:0 40px 120px rgba(30,40,90,.12)}
}
header{padding:18px 20px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border)}
header .title{font-weight:600;font-size:17px}
header .status{font-size:12px;color:var(--muted)}
#chat{flex:1;padding:18px;display:flex;flex-direction:column;gap:14px;overflow-y:auto}
.msg{max-width:70%;padding:14px 18px;border-radius:22px;font-size:14px;line-height:1.55}
.me{align-self:flex-end;background:linear-gradient(135deg,#6c8cff,#8fa6ff);color:white}
.other{align-self:flex-start;background:linear-gradient(135deg,#ff9fcf,#ffc6df);color:white}
.meta{margin-top:6px;font-size:10px;opacity:.7;text-align:right}
#controls{padding:14px 16px;display:flex;gap:10px;border-top:1px solid var(--border);align-items:center}
#controls .iconBtn{border:none;background:transparent;font-size:18px;cursor:pointer}
#controls input{flex:1;border:1px solid var(--border);padding:14px 16px;border-radius:20px;font-size:14px}
#controls .sendBtn{padding:0 22px;border:none;border-radius:20px;background:linear-gradient(135deg,#6c8cff,#8fa6ff);color:white;font-weight:600}
.page{position:fixed;inset:0;background:#f6f8ff;display:none;flex-direction:column;z-index:10}
.page header{background:white;border-bottom:1px solid var(--border);padding:12px}
.photo{width:100%;border-radius:18px;margin-bottom:12px}
</style>
</head>
<body>

<div id="app">
  <header>
    <div style="display:flex;flex-direction:column;gap:2px">
      <div class="title">Sunahh</div>
      <div class="status" id="onlineStatus">connecting‚Ä¶</div>
      <div class="status" id="topInfo">üå° --¬∞C ¬∑ üîã --%</div>
    </div>
  </header>

  <div id="chat"></div>

  <div id="controls">
    <button class="iconBtn" id="voiceBtn">üé§</button>
    <button class="iconBtn" id="openPhotos">üì∑</button>
    <button class="iconBtn" id="openYT">‚ñ∂Ô∏è</button>
    <input id="msgInput" placeholder="say something warm‚Ä¶" />
    <button class="sendBtn" id="send">Send</button>
  </div>
</div>

<div id="ytPage" class="page">
  <header><button onclick="ytPage.style.display='none'">‚Üê back</button></header>
  <div style="padding:14px;display:flex;gap:10px">
    <input id="ytInput" placeholder="Paste YouTube link‚Ä¶" style="flex:1;padding:12px;border-radius:12px;border:1px solid var(--border)" />
    <button id="sendYT" style="padding:0 16px;border:none;border-radius:12px;background:var(--primary);color:white">Play</button>
  </div>
  <iframe id="ytFrame" style="width:100%;flex:1;border:none" allow="autoplay"></iframe>
</div>

<div id="photoPage" class="page">
  <header><button onclick="photoPage.style.display='none'">‚Üê back</button></header>
  <input type="file" id="photoInput" accept="image/*" />
  <div id="photoFeed" style="padding:14px"></div>
</div>

<script>
(function(){
  const uid = (location.hash.replace('#','').toLowerCase() || 'abhishek');
  const other = uid === 'abhishek' ? 'sana' : 'abhishek';

  firebase.initializeApp({
    apiKey:"AIzaSyBxm9XNECnnua2ygeOSfQUQAoon8VBabgQ",
    databaseURL:"https://sunahh-43bb8-default-rtdb.firebaseio.com",
    storageBucket:"sunahh-43bb8.appspot.com"
  });

  const db = firebase.database();
  const storage = firebase.storage();
  const root = db.ref('sunahh');
  const me = root.child('users/' + uid);
  const partner = root.child('users/' + other);

  setInterval(() => me.update({ online:true, last:Date.now() }), 4000);
  window.addEventListener('beforeunload', () => me.update({ online:false, last:Date.now() }));

  partner.on('value', s => {
    const d = s.val(); if(!d) return;
    if(d.online){ onlineStatus.textContent = 'online'; }
    else if(d.last){
      const mins = Math.floor((Date.now()-d.last)/60000);
      onlineStatus.textContent = mins <= 1 ? 'last seen just now' : `last seen ${mins} min ago`;
    }
    topInfo.textContent = `üå° ${d.temp||'--¬∞C'} ¬∑ üîã ${d.battery!=null?d.battery+'%':'--%'}`;
  });

  fetch('https://api.open-meteo.com/v1/forecast?latitude=28.61&longitude=77.20&current_weather=true')
    .then(r=>r.json()).then(d=> me.update({ temp:d.current_weather.temperature+'¬∞C' }));

  if(navigator.getBattery){
    navigator.getBattery().then(b=>{
      const upd=()=> me.update({ battery:Math.round(b.level*100) });
      upd(); b.onlevelchange = upd;
    });
  }

  root.child('messages').limitToLast(200).on('child_added', s => {
    const m = s.val(); const key = s.key;
    const div = document.createElement('div');
    div.className = 'msg ' + (m.from === uid ? 'me' : 'other');

    if(m.type === 'voice'){
      div.innerHTML = `<audio controls src="${m.url}" style="width:100%"></audio><div class="meta">voice note</div>`;
    } else {
      const meta = m.from === uid
        ? `<div class='meta' id='seen-${key}'>${m.seen?'seen':'sent'}</div>`
        : `<div class='meta'>${new Date(m.time).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>`;
      div.innerHTML = `${m.text}${meta}`;
    }
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;

    if(m.from !== uid && m.type !== 'voice'){
      root.child('messages/'+key).update({ seen:true });
    }
    if(m.from === uid && m.type !== 'voice'){
      root.child('messages/'+key+'/seen').on('value', snap=>{
        if(snap.val()){
          const el=document.getElementById('seen-'+key);
          if(el) el.textContent='seen';
        }
      });
    }
  });

  function sendMessage(){
    const t = msgInput.value.trim();
    if(!t) return;
    root.child('messages').push({ from:uid, text:t, time:Date.now(), seen:false });
    msgInput.value='';
  }
  send.onclick = sendMessage;
  msgInput.addEventListener('keydown', e=>{
    if(e.key==='Enter'){ e.preventDefault(); sendMessage(); }
  });

  let mediaRecorder; let audioChunks=[];
  voiceBtn.onclick = async ()=>{
    if(!mediaRecorder){
      const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.ondataavailable = e=> audioChunks.push(e.data);
      mediaRecorder.onstop = ()=>{
        const blob = new Blob(audioChunks,{ type:'audio/webm' });
        audioChunks=[];
        const ref = storage.ref('voices/'+Date.now()+'.webm');
        ref.put(blob).then(()=>ref.getDownloadURL()).then(url=>{
          root.child('messages').push({ from:uid, type:'voice', url, time:Date.now() });
        });
      };
    }
    if(mediaRecorder.state==='inactive'){
      mediaRecorder.start(); voiceBtn.textContent='‚èπÔ∏è';
    } else {
      mediaRecorder.stop(); voiceBtn.textContent='üé§';
    }
  };

  openPhotos.onclick = ()=> photoPage.style.display='flex';
  photoInput.onchange = e=>{
    const f=e.target.files[0]; if(!f) return;
    const ref=storage.ref('photos/'+Date.now()+f.name);
    ref.put(f).then(()=>ref.getDownloadURL()).then(url=> root.child('photos').push({ url }));
  };
  root.child('photos').limitToLast(20).on('child_added', s=>{
    const img=document.createElement('img');
    img.src=s.val().url;
    img.className='photo';
    photoFeed.prepend(img);
  });

  openYT.onclick = ()=> ytPage.style.display='flex';
  sendYT.onclick = ()=>{
    const url = ytInput.value.trim(); if(!url) return;
    const id = (url.match(/v=([^&]+)/)||url.match(/youtu.be\/([^?]+)/))?.[1];
    if(!id) return;
    root.child('yt').set({ id, by: uid, time: Date.now() });
    ytInput.value='';
  };
  root.child('yt').on('value', s=>{
    const d=s.val(); if(!d) return;
    ytFrame.src = `https://www.youtube.com/embed/${d.id}?autoplay=1&rel=0`;
  });
})();
</script>
</body>
</html>
